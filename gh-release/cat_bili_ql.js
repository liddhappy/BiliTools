"use strict";var t=require("path"),e=require("pako"),n=require("fs"),i=require("querystring"),a=require("nodemailer"),s=require("got"),o=require("tough-cookie"),r=require("tunnel"),c=require("crypto"),u=require("qs"),d=require("axios");function f(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}function l(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(n){if("default"!==n){var i=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,i.get?i:{enumerable:!0,get:function(){return t[n]}})}})),e.default=t,Object.freeze(e)}var p=l(t),g=l(e),h=l(n),m=l(i),_=l(a),y=l(s),w=l(o),v=l(r),$=l(c),T=f(d);function b(t){const e=t||S(),n=e.getFullYear(),i=e.getMonth()+1;return 2===i?n%4==0&&n%100!=0||n%400==0?29:28:[4,6,9,11].includes(i)?30:31}function S(){const t=new Date,e=t.getTime(),n=t.getTimezoneOffset()/60;return new Date(e+36e5*(n+8))}function I(t,e){return Math.ceil(e/t)}function O(t,e,n){if(n&&"boolean"!=typeof n&&(e=n=void 0),void 0===n&&("boolean"==typeof e?(n=e,e=void 0):"boolean"==typeof t&&(n=t,t=void 0)),void 0===t&&void 0===e?(t=0,e=1):void 0===e&&(e=t,t=0),t>e){const n=t;t=e,e=n}if(n||t%1||e%1){const n=Math.random();return Math.min(t+n*(e-t+parseFloat("1e-"+((n+"").length-1))),e)}return t+Math.floor(Math.random()*(e-t+1))}const E={value:""},C={log:x,error:function(t){x("error",t)},warn:function(t){x("warn",t)},info:function(t){x("info",t)},verbose:function(t){x("verbose",t)},debug:function(t){x("debug",t)}};function x(t,e){const n=S().toString().match(/\w{2}:\w{2}:\w{2}/)[0];if(function(t="debug"){const e=["error","warn","info","verbose","debug"],n=e.indexOf(t);return n>0?e.slice(0,n+1):e}().includes(t)){const t=`[${n}] ${e}`;E.value+=t+"\r\n"}console.log("[%s %s] %s",t,n,e)}const N=()=>"QingLong"===process.env.BARK_GROUP||"/ql"===process.env.QL_DIR;class A{static configFileName=function(){const t=N()?"cat_bili_config":"config",e=".json",{BILITOOLS_FILE_NAME:n}=process.env;return n?n.endsWith(e)?n:`${n}.json`:t+e}();static isQingLongPanel=N()}const P=t=>p.resolve(process.cwd(),t);function k(t){throw new Error(t||"配置文件不存（位置不正确）在或 cookie 不存在！！！")}const L=[()=>require(P("./config/config.dev.json")),()=>require(`./${A.configFileName}`),()=>require(P(`./config/${A.configFileName}`))],R=[()=>require("./config.json"),()=>require(P("./config/config.json"))],U=()=>{const{BILITOOLS_CONFIG:t,BILI_SCF_CONFIG:e,BILI_CONFIG:n}=process.env,i=t||e||n;if(i)try{return JSON.parse((t=>{try{const e=Buffer.from(t,"base64").toString("binary").split("").map((t=>t.charCodeAt(0))),n=g.inflate(new Uint8Array(e)),i=String.fromCharCode.apply(null,new Uint16Array(n));try{return unescape(i)}catch(t){return i}}catch(t){throw new Error("Error: 当前字符串不能被Gzip解密")}})(i))}catch{k("环境中的配置不是有效的 JSON 字符串！")}};function B(t){const e=t.account.filter((t=>t.cookie));if(0===e.length)return;if(A.isQingLongPanel)return function(t){const e=process.argv.find((t=>t.includes("--item")||t.includes("-i")||t.includes("-I")));if(!e)return t[0];const n=Number(e.split("=")[1])-1;return!n||n>=t.length||n<0?(C.warn("似乎想要指定一个不存在的用户，我们将指定第一个用户"),t[0]):t[n]}(e);C.warn("在单用户场景下配置了多用户，我们将放弃多余的配置");const n=e[0];return n.message=Object.assign(t.message||{},n.message),n}const D=function(){let t,e=!1;A.isQingLongPanel&&L.splice(0,1,...R);for(const n of L)try{if(t=n(),t)break;e=!0}catch(t){const{message:n={}}=t;n.includes&&n.includes("in JSON at position")&&(e=!0);continue}if(t||(t=U()),t||(e&&k("配置文件存在，但是无法解析！可能 JSON 格式不正确！"),k()),t.account&&t.account.length){const e=B(t);if(e)return e}return t.cookie||k(),t}(),{cookie:G}=D;function M(t){return t?t.split("; ").map((t=>t.split("="))):[]}function H(t,e){return t?e&&0!==e.length?function(t){const e=Object.keys(t).reduce(((e,n)=>e+`${n}=${t[n]}; `),"");return e.substring(0,e.length-2||0)}(function(t,e){const n=M(null==e?void 0:e[0]).filter((t=>2===t.length)),i=M(t).concat(n).filter((t=>2===t.length)),a={};for(const t of i)a[t[0]]?a[t[0]]=t[1]:Object.defineProperty(a,t[0],{value:t[1],enumerable:!0,writable:!0});return a}(t,e)):t:""}function K(t,e){if(!t)return null;const n=`(?:^|)${e}=([^;]*)(?:;|$)`,i=t.match(n);return i?i[1]:null}function j(){return K(G,"bili_jct")||""}var q,J;function Y(t){return null==t?void 0:t.map((t=>Number(t)))}class Q{static config=D;static COOKIE=D.cookie;static BILIJCT=j();static NICKNAME="";static USERID=function(){return Number(K(G,"DedeUserID"))||0}();static USER_AGENT=D.userAgent;static BILI_TARGET_COINS=D.targetCoins??5;static biliApiDelay=D.apiDelay||[2,6];static BILI_API_DELAY=Array.isArray(Q.biliApiDelay)?Q.biliApiDelay:[Q.biliApiDelay];static BILI_CUSTOMIZE_UP=Y(D.customizeUp)||[];static BILI_GIFT_UP=Y(D.giftUp)||Q.BILI_CUSTOMIZE_UP||[];static BILI_TARGET_LEVEL=D.targetLevel??6;static BILI_STAY_COINS=D.stayCoins??0;static BILI_UPPER_ACC_MATCH=D.upperAccMatch||!0;static BILI_COIN_RETRY_NUM=D.coinRetryNum||4;static CHARGE_ID=D.chargeUpId||Q.USERID;static CHARGE_PRESET_TIME=D.chargePresetTime||31;static PUSHPLUS_TOKEN=process.env.PUSHPLUS_TOKEN||(null===(q=D.message)||void 0===q?void 0:q.pushplusToken);static MATCH_COINS=D.matchCoins??5;static MATCH_SELECTION=D.matchSelection??1;static MATCH_DIFF=D.matchDiff??0;static MESSAGE_API=null===(J=D.message)||void 0===J?void 0:J.api}class F{static money=0;static coinsTask=Q.BILI_TARGET_COINS;static share=!1;static watch=!1;static currentStartFun=0;static bCoinCouponBalance=0;static vipType=0}class X{static DAILY_TRIGGER_NAME="daily_bili_timer";static HEART_TRIGGER_NAME="heart_bili_timer";static DAILY_RUN_TIME="17:30:00-23:40:00";static HEART_RUN_TIME="12:00:00-20:00:00";static MS2DATE=864e5}!function(){var t;const e=(null===(t=Q.config)||void 0===t?void 0:t.message)||{};Q.PUSHPLUS_TOKEN&&(process.env.PUSH_PLUS_TOKEN=Q.PUSHPLUS_TOKEN),["GOBOT_URL","GOBOT_TOKEN","GOBOT_QQ","SCKEY","QQ_SKEY","QQ_MODE","BARK_PUSH","BARK_SOUND","BARK_GROUP","TG_BOT_TOKEN","TG_USER_ID","TG_PROXY_AUTH","TG_PROXY_HOST","TG_PROXY_PORT","TG_API_HOST","DD_BOT_TOKEN","DD_BOT_SECRET","QYWX_KEY","QYWX_AM","IGOT_PUSH_KEY","PUSH_PLUS_TOKEN","PUSH_PLUS_USER"].forEach((t=>{const n=e[(i=t,i.toLowerCase().replace(/_(\w)/g,((t,e)=>e.toUpperCase())))]||e[t]||process.env[t];var i;n&&(process.env[t]=n)}))}();const W=new function(t,e){return new class{constructor(t,e){this.name=t,this.data=null,this.dataFile="box.dat",this.logs=[],this.logSeparator="\n",this.startTime=(new Date).getTime(),Object.assign(this,e),this.log("",`🔔${this.name}, 开始!`)}isNode(){return"undefined"!=typeof module&&!!module.exports}isQuanX(){return"undefined"!=typeof $task}isSurge(){return"undefined"!=typeof $httpClient&&"undefined"==typeof $loon}isLoon(){return"undefined"!=typeof $loon}getScript(t){return new Promise((e=>{W.get({url:t},((t,n,i)=>e(i)))}))}runScript(t,e){return new Promise((n=>{let i=this.getdata("@chavy_boxjs_userCfgs.httpapi");i=i?i.replace(/\n/g,"").trim():i;let a=this.getdata("@chavy_boxjs_userCfgs.httpapi_timeout");a=a?1*a:20,a=e&&e.timeout?e.timeout:a;const[s,o]=i.split("@"),r={url:`http://${o}/v1/scripting/evaluate`,body:{script_text:t,mock_type:"cron",timeout:a},headers:{"X-Key":s,Accept:"*/*"}};W.post(r,((t,e,i)=>n(i)))})).catch((t=>this.logErr(t)))}loaddata(){if(!this.isNode())return{};{this.fs=this.fs?this.fs:require("fs"),this.path=this.path?this.path:require("path");const t=this.path.resolve(this.dataFile),e=this.path.resolve(process.cwd(),this.dataFile),n=this.fs.existsSync(t),i=!n&&this.fs.existsSync(e);if(!n&&!i)return{};{const i=n?t:e;try{return JSON.parse(this.fs.readFileSync(i))}catch(t){return{}}}}}writedata(){if(this.isNode()){this.fs=this.fs?this.fs:require("fs"),this.path=this.path?this.path:require("path");const t=this.path.resolve(this.dataFile),e=this.path.resolve(process.cwd(),this.dataFile),n=this.fs.existsSync(t),i=!n&&this.fs.existsSync(e),a=JSON.stringify(this.data);n?this.fs.writeFileSync(t,a):i?this.fs.writeFileSync(e,a):this.fs.writeFileSync(t,a)}}lodash_get(t,e,n){const i=e.replace(/\[(\d+)\]/g,".$1").split(".");let a=t;for(const t of i)if(a=Object(a)[t],void 0===a)return n;return a}lodash_set(t,e,n){return Object(t)!==t||(Array.isArray(e)||(e=e.toString().match(/[^.[\]]+/g)||[]),e.slice(0,-1).reduce(((t,n,i)=>Object(t[n])===t[n]?t[n]:t[n]=Math.abs(e[i+1])>>0==+e[i+1]?[]:{}),t)[e[e.length-1]]=n),t}getdata(t){let e=this.getval(t);if(/^@/.test(t)){const[,n,i]=/^@(.*?)\.(.*?)$/.exec(t),a=n?this.getval(n):"";if(a)try{const t=JSON.parse(a);e=t?this.lodash_get(t,i,""):e}catch(t){e=""}}return e}setdata(t,e){let n=!1;if(/^@/.test(e)){const[,i,a]=/^@(.*?)\.(.*?)$/.exec(e),s=this.getval(i),o=i?"null"===s?null:s||"{}":"{}";try{const e=JSON.parse(o);this.lodash_set(e,a,t),n=this.setval(JSON.stringify(e),i)}catch(e){const s={};this.lodash_set(s,a,t),n=this.setval(JSON.stringify(s),i)}}else n=W.setval(t,e);return n}getval(t){return this.isSurge()||this.isLoon()?$persistentStore.read(t):this.isQuanX()?$prefs.valueForKey(t):this.isNode()?(this.data=this.loaddata(),this.data[t]):this.data&&this.data[t]||null}setval(t,e){return this.isSurge()||this.isLoon()?$persistentStore.write(t,e):this.isQuanX()?$prefs.setValueForKey(t,e):this.isNode()?(this.data=this.loaddata(),this.data[e]=t,this.writedata(),!0):this.data&&this.data[e]||null}initGotEnv(t){this.got=this.got?this.got:y,this.cktough=this.cktough?this.cktough:w,this.ckjar=this.ckjar?this.ckjar:new this.cktough.CookieJar,t&&(t.headers=t.headers?t.headers:{},void 0===t.headers.Cookie&&void 0===t.cookieJar&&(t.cookieJar=this.ckjar))}get(t,e=(()=>{})){t.headers&&(delete t.headers["Content-Type"],delete t.headers["Content-Length"]),this.isSurge()||this.isLoon()?$httpClient.get(t,((t,n,i)=>{!t&&n&&(n.body=i,n.statusCode=n.status),e(t,n,i)})):this.isQuanX()?$task.fetch(t).then((t=>{const{statusCode:n,statusCode:i,headers:a,body:s}=t;e(null,{status:n,statusCode:i,headers:a,body:s},s)}),(t=>e(t))):this.isNode()&&(this.initGotEnv(t),this.got(t).on("redirect",((t,e)=>{try{const n=t.headers["set-cookie"].map(this.cktough.Cookie.parse).toString();this.ckjar.setCookieSync(n,null),e.cookieJar=this.ckjar}catch(t){this.logErr(t)}})).then((t=>{const{statusCode:n,statusCode:i,headers:a,body:s}=t;e(null,{status:n,statusCode:i,headers:a,body:s},s)}),(t=>e(t))))}post(t,e=(()=>{})){if(t.body&&t.headers&&!t.headers["Content-Type"]&&(t.headers["Content-Type"]="application/x-www-form-urlencoded"),delete t.headers["Content-Length"],this.isSurge()||this.isLoon())$httpClient.post(t,((t,n,i)=>{!t&&n&&(n.body=i,n.statusCode=n.status),e(t,n,i)}));else if(this.isQuanX())t.method="POST",$task.fetch(t).then((t=>{const{statusCode:n,statusCode:i,headers:a,body:s}=t;e(null,{status:n,statusCode:i,headers:a,body:s},s)}),(t=>e(t)));else if(this.isNode()){this.initGotEnv(t);const{url:n,...i}=t;this.got.post(n,i).then((t=>{const{statusCode:n,statusCode:i,headers:a,body:s}=t;e(null,{status:n,statusCode:i,headers:a,body:s},s)}),(t=>e(t)))}}time(t){const e={"M+":(new Date).getMonth()+1,"d+":(new Date).getDate(),"H+":(new Date).getHours(),"m+":(new Date).getMinutes(),"s+":(new Date).getSeconds(),"q+":Math.floor(((new Date).getMonth()+3)/3),S:(new Date).getMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,((new Date).getFullYear()+"").substr(4-RegExp.$1.length)));for(const n in e)new RegExp("("+n+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?e[n]:("00"+e[n]).substr((""+e[n]).length)));return t}msg(e=t,n="",i="",a){const s=t=>!t||!this.isLoon()&&this.isSurge()?t:"string"==typeof t?this.isLoon()?t:this.isQuanX()?{"open-url":t}:void 0:"object"==typeof t&&(t["open-url"]||t["media-url"])?this.isLoon()?t["open-url"]:this.isQuanX()?t:void 0:void 0;W.isMute||(this.isSurge()||this.isLoon()?$notification.post(e,n,i,s(a)):this.isQuanX()&&$notify(e,n,i,s(a))),this.logs.push("","==============📣系统通知📣=============="),this.logs.push(e),n&&this.logs.push(n),i&&this.logs.push(i)}log(...t){t.length>0?this.logs=[...this.logs,...t]:C.info(this.logs.join(this.logSeparator))}logErr(t,e){!this.isSurge()&&!this.isQuanX()&&!this.isLoon()?W.log("",`❗️${this.name}, 错误!`,t.stack):W.log("",`❗️${this.name}, 错误!`,t)}wait(t){return new Promise((e=>setTimeout(e,t)))}done(t={}){const e=((new Date).getTime()-this.startTime)/1e3;this.log("",`🔔${this.name}, 结束! 🕛 ${e} 秒`),this.log(),(this.isSurge()||this.isQuanX()||this.isLoon())&&$done(t)}}(t,e)};let z="",V="",Z="",tt="QingLong",et="",nt="",it="",at="",st="",ot="api.telegram.org",rt="",ct="",ut="",dt="",ft="",lt="",pt="";async function gt(t,e){var n;const i=null===(n=Q.config.message)||void 0===n?void 0:n.email;if(!(i&&i.pass&&i.from&&i.host))return;const a=Number(i.port)||465,s=_.createTransport({host:i.host,port:a,secure:465===a,auth:{user:i.from,pass:i.pass}}),o=await s.sendMail({from:`${t} <${i.from}>`,to:i.to,subject:t,headers:{"Content-Type":"text/plain; charset=utf-8"},text:e});C.info(`邮件消息已发送: ${o.messageId}`)}async function ht(t,e){try{const n=Q.MESSAGE_API;if(!n)return;const i=n.replace("{title}",t).replace("{text}",e);await W.get(i)}catch(t){}}function mt(t,e,n=2100){return new Promise((i=>{if(z){e=e.replace(/[\n\r]/g,"\n\n");const a={url:z.includes("SCT")?`https://sctapi.ftqq.com/${z}.send`:`https://sc.ftqq.com/${z}.send`,body:`text=${t}&desp=${e}`,headers:{"Content-Type":"application/x-www-form-urlencoded"},timeout:15e3};setTimeout((()=>{W.post(a,((t,e,n)=>{try{t?(C.info("发送通知调用API失败！！\n"),C.info(t)):0===(n=JSON.parse(n)).errno||0===n.data.errno?C.info("server酱发送通知消息成功🎉\n"):1024===n.errno?C.info(`server酱发送通知消息异常: ${n.errmsg}\n`):C.info(`server酱发送通知消息异常\n${JSON.stringify(n)}`)}catch(t){W.logErr(t,e)}finally{i(n)}}))}),n)}else i("")}))}function _t(t,e,n={}){return new Promise((i=>{if(V){const a={url:`${V}/${encodeURIComponent(t)}/${encodeURIComponent(e)}?sound=${Z}&group=${tt}&${m.stringify(n)}`,headers:{"Content-Type":"application/x-www-form-urlencoded"},timeout:15e3};W.get(a,((t,e,n)=>{try{t?(C.info("Bark APP发送通知调用API失败！！\n"),C.info(t)):200===(n=JSON.parse(n)).code?C.info("Bark APP发送通知消息成功🎉\n"):C.info(`${n.message}\n`)}catch(t){W.logErr(t,e)}finally{i("")}}))}else i("")}))}function yt(t,e){return new Promise((n=>{if(et&&nt){const i={url:`https://${ot}/bot${et}/sendMessage`,body:`chat_id=${nt}&text=${t}\n\n${e}&disable_web_page_preview=true`,headers:{"Content-Type":"application/x-www-form-urlencoded"},timeout:15e3};if(it&&at){const t={https:v.httpsOverHttp({proxy:{host:it,port:+at,proxyAuth:st}})};Object.assign(i,{agent:t})}W.post(i,((t,e,i)=>{try{t?(C.info("telegram发送通知消息失败！！\n"),C.info(t)):(i=JSON.parse(i)).ok?C.info("Telegram发送通知消息成功🎉。\n"):400===i.error_code?C.info("请主动给bot发送一条消息并检查接收用户ID是否正确。\n"):401===i.error_code&&C.info("Telegram bot token 填写错误。\n")}catch(t){W.logErr(t,e)}finally{n(i)}}))}else n("")}))}function wt(t,e){return new Promise((n=>{const i={url:`https://oapi.dingtalk.com/robot/send?access_token=${rt}`,json:{msgtype:"text",text:{content:` ${t}\n\n${e}`}},headers:{"Content-Type":"application/json"},timeout:15e3};if(rt&&ct){const t=require("crypto"),e=Date.now(),a=t.createHmac("sha256",ct);a.update(`${e}\n${ct}`);const s=encodeURIComponent(a.digest("base64"));i.url=`${i.url}&timestamp=${e}&sign=${s}`,W.post(i,((t,e,i)=>{try{t?(C.info("钉钉发送通知消息失败！！\n"),C.info(t)):0===(i=JSON.parse(i)).errcode?C.info("钉钉发送通知消息成功🎉。\n"):C.info(`${i.errmsg}\n`)}catch(t){W.logErr(t,e)}finally{n(i)}}))}else rt?W.post(i,((t,e,i)=>{try{t?(C.info("钉钉发送通知消息失败！！\n"),C.info(t)):0===(i=JSON.parse(i)).errcode?C.info("钉钉发送通知消息完成。\n"):C.info(`${i.errmsg}\n`)}catch(t){W.logErr(t,e)}finally{n(i)}})):n("")}))}function vt(t,e){return new Promise((n=>{const i={url:`https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=${ut}`,json:{msgtype:"text",text:{content:` ${t}\n\n${e}`}},headers:{"Content-Type":"application/json"},timeout:15e3};ut?W.post(i,((t,e,i)=>{try{t?(C.info("企业微信发送通知消息失败！！\n"),C.info(t)):0===(i=JSON.parse(i)).errcode?C.info("企业微信发送通知消息成功🎉。\n"):C.info(`${i.errmsg}\n`)}catch(t){W.logErr(t,e)}finally{n(i)}})):n("")}))}function $t(t){const e=dt.split(",");if(e[2]){const n=e[2].split("|");let i="";for(let e=0;e<n.length;e++){const a="签到号 "+(e+1);t.match(a)&&(i=n[e])}return i||(i=e[2]),i}return"@all"}function Tt(t,e){return new Promise((n=>{if(dt){const i=dt.split(","),a={url:"https://qyapi.weixin.qq.com/cgi-bin/gettoken",json:{corpid:`${i[0]}`,corpsecret:`${i[1]}`},headers:{"Content-Type":"application/json"},timeout:15e3};W.post(a,((a,s,o)=>{const r=e.replace(/\n/g,"<br/>"),c=JSON.parse(o).access_token;let u;switch(i[4]){case"0":u={msgtype:"textcard",textcard:{title:`${t}`,description:`${e}`,url:"https://github.com/whyour/qinglong",btntxt:"更多"}};break;case"1":u={msgtype:"text",text:{content:`${t}\n\n${e}`}};break;default:u={msgtype:"mpnews",mpnews:{articles:[{title:`${t}`,thumb_media_id:`${i[4]}`,author:"智能助手",content_source_url:"",content:`${r}`,digest:`${e}`}]}}}i[4]||(u={msgtype:"text",text:{content:`${t}\n\n${e}`}}),u={url:`https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=${c}`,json:{touser:`${$t(e)}`,agentid:`${i[3]}`,safe:"0",...u},headers:{"Content-Type":"application/json"}},W.post(u,((t,i,a)=>{try{t?(C.info("成员ID:"+$t(e)+"企业微信应用消息发送通知消息失败！！\n"),C.info(t)):0===(a=JSON.parse(a)).errcode?C.info("成员ID:"+$t(e)+"企业微信应用消息发送通知消息成功🎉。\n"):C.info(`${a.errmsg}\n`)}catch(t){W.logErr(t,i)}finally{n(a)}}))}))}else n("")}))}function bt(t,e,n={}){return new Promise((i=>{if(ft){if(!new RegExp("^[a-zA-Z0-9]{24}$").test(ft))return C.info("您所提供的IGOT_PUSH_KEY无效\n"),void i("");const a={url:`https://push.hellyw.com/${ft.toLowerCase()}`,body:`title=${t}&content=${e}&${m.stringify(n)}`,headers:{"Content-Type":"application/x-www-form-urlencoded"},timeout:15e3};W.post(a,((t,e,n)=>{try{t?(C.info("发送通知调用API失败！！\n"),C.info(t)):("string"==typeof n&&(n=JSON.parse(n)),0===n.ret?C.info("iGot发送通知消息成功🎉\n"):C.info(`iGot发送通知消息失败：${n.errMsg}\n`))}catch(t){W.logErr(t,e)}finally{i(n)}}))}else i("")}))}function St(t,e){return new Promise((n=>{if(lt){e=e.replace(/[\n\r]/g,"<br>");const i={token:`${lt}`,title:`${t}`,content:`${e}`,topic:`${pt}`},a={url:"https://www.pushplus.plus/send",body:JSON.stringify(i),headers:{"Content-Type":" application/json"},timeout:15e3};W.post(a,((t,e,i)=>{try{t?(C.info(`push+发送${pt?"一对多":"一对一"}通知消息失败！！\n`),C.info(t)):200===(i=JSON.parse(i)).code?C.info(`push+发送${pt?"一对多":"一对一"}通知消息完成。\n`):C.info(`push+发送${pt?"一对多":"一对一"}通知消息失败：${i.msg}\n`)}catch(t){W.logErr(t,e)}finally{n(i)}}))}else n("")}))}async function It(t,e){C.info("----【消息推送】----"),t=`Bili-${Q.NICKNAME}-${t}`,await async function(t,e,n={},i="\n\n本通知 By：https://github.com/catlair/BiliTools"){e+=i,await Promise.all([mt(t,e),St(t,e)]),await Promise.all([_t(t,e,n),yt(t,e),wt(t,e),vt(t,e),Tt(t,e),bt(t,e,n),gt(t,e),ht(t,e)])}(t,e,void 0,"")}function Ot(t){const e=Q.BILI_API_DELAY;let n;n=1===e.length?1e3*e[0]:1e3*O(e[0]||2,e[1]||6),n=t||n;const i=(new Date).getTime()+parseInt(n,10);for(;(new Date).getTime()<i;);return new Promise((t=>{t("done")}))}process.env.PUSH_KEY&&(z=process.env.PUSH_KEY),process.env.QQ_SKEY&&process.env.QQ_SKEY,process.env.QQ_MODE&&process.env.QQ_MODE,process.env.BARK_PUSH?(V=process.env.BARK_PUSH.indexOf("https")>-1||process.env.BARK_PUSH.indexOf("http")>-1?process.env.BARK_PUSH:`https://api.day.app/${process.env.BARK_PUSH}`,process.env.BARK_SOUND&&(Z=process.env.BARK_SOUND),process.env.BARK_GROUP&&(tt=process.env.BARK_GROUP)):V&&-1===V.indexOf("https")&&-1===V.indexOf("http")&&(V=`https://api.day.app/${V}`),process.env.TG_BOT_TOKEN&&(et=process.env.TG_BOT_TOKEN),process.env.TG_USER_ID&&(nt=process.env.TG_USER_ID),process.env.TG_PROXY_AUTH&&(st=process.env.TG_PROXY_AUTH),process.env.TG_PROXY_HOST&&(it=process.env.TG_PROXY_HOST),process.env.TG_PROXY_PORT&&(at=process.env.TG_PROXY_PORT),process.env.TG_API_HOST&&(ot=process.env.TG_API_HOST),process.env.DD_BOT_TOKEN&&(rt=process.env.DD_BOT_TOKEN,process.env.DD_BOT_SECRET&&(ct=process.env.DD_BOT_SECRET)),process.env.QYWX_KEY&&(ut=process.env.QYWX_KEY),process.env.QYWX_AM&&(dt=process.env.QYWX_AM),process.env.IGOT_PUSH_KEY&&(ft=process.env.IGOT_PUSH_KEY),process.env.PUSH_PLUS_TOKEN&&(lt=process.env.PUSH_PLUS_TOKEN),process.env.PUSH_PLUS_USER&&(pt=process.env.PUSH_PLUS_USER);const Et={"User-Agent":Q.USER_AGENT||"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.110 Safari/537.36 Edg/96.0.1054.62","content-type":"application/x-www-form-urlencoded","accept-language":"accept-language: zh-CN,zh;q=0.9,en-GB;q=0.8,en;q=0.7"};var Ct;T.default.defaults.headers.common.Cookie=Q.COOKIE,T.default.defaults.withCredentials=!0,T.default.defaults.headers.common["User-Agent"]=Et["User-Agent"],T.default.defaults.headers.post["content-type"]=Et["content-type"],T.default.defaults.headers.common["accept-language"]=Et["accept-language"],function(t){t[t["应用程序不存在或已被封禁"]=-1]="应用程序不存在或已被封禁",t[t["Access Key错误"]=-2]="Access Key错误",t[t["API校验密匙错误"]=-3]="API校验密匙错误",t[t["调用方对该Method没有权限"]=-4]="调用方对该Method没有权限",t[t["账号未登录"]=-101]="账号未登录",t[t["账号被封停"]=-102]="账号被封停",t[t["积分不足"]=-103]="积分不足",t[t["硬币不足"]=-104]="硬币不足",t[t["验证码错误"]=-105]="验证码错误",t[t["账号非正式会员或在适应期"]=-106]="账号非正式会员或在适应期",t[t["应用不存在或者被封禁"]=-107]="应用不存在或者被封禁",t[t["未绑定手机?"]=-108]="未绑定手机?",t[t["未绑定手机"]=-110]="未绑定手机",t[t["csrf 校验失败"]=-111]="csrf 校验失败",t[t["系统升级中"]=-112]="系统升级中",t[t["账号尚未实名认证"]=-113]="账号尚未实名认证",t[t["请先绑定手机"]=-114]="请先绑定手机",t[t["请先完成实名认证"]=-115]="请先完成实名认证"}(Ct||(Ct={}));const xt="https://account.bilibili.com",Nt="https://live.bilibili.com",At="https://www.bilibili.com/",Pt="https://account.bilibili.com",kt="https://api.live.bilibili.com",Lt="https://api.bilibili.com",Rt="https://manga.bilibili.com",Ut="https://api.vc.bilibili.com";T.default.interceptors.response.use((t=>{var e,n;const i=(null===(e=t.headers)||void 0===e?void 0:e["set-cookie"])||[];Q.COOKIE=H(Q.COOKIE,i);const a=null===(n=t.data)||void 0===n?void 0:n.code;switch(a){case Ct["账号未登录"]:case Ct["账号被封停"]:(async()=>{C.error(`运行结束：${Ct[a]}`),await It(`异常：${Ct[a]}`,E.value),process.exit(0)})();break;default:return t}}),(t=>function(t){const e=t.config;if(0===e.retry)return Promise.reject(t);e.retry||(e.retry=2);if(e.__retryCount=e.__retryCount||0,e.__retryCount>=e.retry)return Promise.reject(t);e.__retryCount+=1;return new Promise((function(t){setTimeout((function(){t(void 0)}),e.retryDelay||100)})).then((function(){return T.default(e)}))}(t)));const Bt=T.default.create({baseURL:Pt}),Dt=T.default.create({baseURL:kt,headers:{Referer:At}}),Gt=T.default.create({baseURL:Lt,headers:{Referer:At}}),Mt=T.default.create({baseURL:Rt}),Ht=T.default.create({baseURL:Ut});async function Kt(t=3394945){const e=(new Date).getTime(),{data:n}=await Dt.get(`/xlive/web-room/v1/gift/bag_list?t=${e}&room_id=${t}`);return n}async function jt(t=1,e=10){t>10&&(t=10);const{data:n}=await Dt.get(`/xlive/app-ucenter/v1/user/GetMyMedals?page=${t}&page_size=${e}`);return n}async function qt({ruid:t,gift_num:e,bag_id:n,gift_id:i,roomid:a}){const s=Q.BILIJCT,o=s,r=u.stringify({gift_id:i,ruid:t,gift_num:e,bag_id:n,biz_id:a,rnd:(new Date).getTime(),send_ruid:0,storm_beat_id:0,metadata:"",price:0,visit_id:"",csrf:s,platform:"pc",biz_code:"Live",csrf_token:o,uid:Q.USERID}),{data:c}=await Dt.post("/xlive/revenue/v2/gift/sendBag",r,{headers:{Origin:Nt}});return c}function Jt(t,e,n,i,a){const s=j(),o=s,r=[K(G,"LIVE_BUVID")||"","xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(t=>{const e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)}))];return{ua:Q.USER_AGENT,id:[n,e,a,t],csrf_token:s,csrf:o,device:r,uname:i}}async function Yt(){try{await async function(){const{data:t}=await T.default.get("https://api.live.bilibili.com/relation/v1/Feed/heartBeat");return t}()}catch{}}async function Qt(t){const{data:{area_id:e,parent_area_id:n,room_id:i}}=await async function(t){const{data:e}=await Dt.get(`/room/v1/Room/get_info?room_id=${t}&from=room`);return e}(t);return{room_id:i,area_id:e,parent_area_id:n}}async function Ft(t,e){const n={id:JSON.stringify(t.id),device:JSON.stringify(t.device),ts:(new Date).getTime(),is_patch:0,heart_beat:"[]",ua:t.ua,visit_id:"",csrf:t.csrf,csrf_token:t.csrf_token};try{const{data:i,code:a}=await async function(t){const{data:e}=await T.default.post("https://live-trace.bilibili.com/xlive/data-interface/v1/x25Kn/E",u.stringify(t));return e}(n);if(0===a)return C.info(`进入【${t.uname}】的直播间`),e.v++,i}catch(t){C.verbose(t)}}async function Xt(t,e,n){if(n.v>6)return;const i={id:JSON.stringify(e.id),device:JSON.stringify(e.device),ets:t.timestamp,benchmark:t.secret_key,time:60,ts:(new Date).getTime(),ua:e.ua},a=function(t,e){const[n,i,a,s]=JSON.parse(t.id),[o,r]=JSON.parse(t.device),{ets:c,time:u,ts:d}=t,f={platform:"web",parent_id:n,area_id:i,seq_id:a,room_id:s,buvid:o,uuid:r,ets:c,time:u,ts:d},l=t.benchmark,p=["MD5","SHA1","SHA256","SHA224","SHA512","SHA384"];let g=JSON.stringify(f);for(const t of e)g=$.createHmac(p[t],l).update(g).digest("hex");return g}(i,t.secret_rule);try{const{data:t,code:s,message:o}=await async function(t){const{data:e}=await T.default.post("https://live-trace.bilibili.com/xlive/data-interface/v1/x25Kn/X",u.stringify(t));return e}(Object.assign({visit_id:"",csrf:e.csrf,csrf_token:e.csrf_token,s:a},i));return 0===s?(C.info(`向【${e.uname}】发送第${n.v}次心跳`),n.v++):C.warn(`向【${e.uname}】发送第${n.v}次心跳失败 ${s} ${o}`),t}catch(t){C.verbose(t)}}async function Wt(t=1,e=10){try{const{code:n,message:i,data:a}=await jt(t,e);return 0!==n?(C.verbose(`获取直播间失败 ${n} ${i}`),null):a}catch(t){return C.verbose(`获取直播间异常 ${t.message}`),null}}async function zt(t=!0){const e=await async function(){let t=0;try{var e,n;const{data:i,code:a}=await Kt();return 0!==a||(null===(e=i.list)||void 0===e?void 0:e.length)<=0?24:(null===(n=i.list)||void 0===n||n.forEach((e=>{if(30607===e.gift_id){const n=(1e3*e.expire_at-(new Date).getTime())/X.MS2DATE;n>6&&n<=7&&(t+=e.gift_num)}})),t>=24?0:24-t)}catch(t){}return 24}();let n;return t?n=await async function(){const{items:t,page_info:e}=await Wt();let{total_page:n}=e;if(n&&n>1){n=n>3?3:n;for(let e=2;e<=n;e++){const n=await Wt(e,10);t.push(...n.items)}}return t}():({items:n}=await Wt()),{fansMedalList:n,heartNum:e}}async function Vt(){C.info("----【直播心跳】----");const{heartNum:t,fansMedalList:e}=await zt(),n=e&&e.length;if(!n)return void C.info("没有勋章列表");const i=Math.ceil(t/n);for(let n=0;n<i;n++)await te(e,t);C.info("完成")}async function Zt(t,e,n,i){if(!i.v||e[n])return await Yt(),await Ot(500),0===i.v?e[n]=await Ft(t,i):e[n]=await Xt(e[n],t,i),"done"}async function te(t,e){const n=[];let i=0;for(let a=0;a<6;a++){let s=0;if(s>=e)break;const o=t.length;i=0;for(let r=0;r<o&&!(s>=e);r++){const e=(new Date).getTime(),o=t[r],{roomid:c,uname:u}=o,{room_id:d,area_id:f,parent_area_id:l}=await Qt(c),p=Jt(d,f,l,u,a);await Zt(p,n,r,{v:a}),await Ot(2e3),i+=(new Date).getTime()-e,s++}a<5&&await Ot(6e4-i)}return"done"}const ee={silver2Coin:!0,liveSignTask:!0,addCoins:!0,mangaSign:!1,shareAndWatch:!0,supGroupSign:!1,liveSendMessage:!1,taskReward:!0,charging:!1,getVipPrivilege:!1,giveGift:!1,matchGame:!1};function ne(t){return function(){for(const t in ee)if(Object.prototype.hasOwnProperty.call(ee,t)){const e=ee[t];switch((Q.config.function||{})[t]){case!0:!1===e&&(ee[t]=!0);break;case!1:!0===e&&(ee[t]=!1)}}ee.addCoins||ee.shareAndWatch||(ee.taskReward=!1)}(),t.map((t=>ee[t.name]?t:null)).filter((t=>t))}async function ie(){const{data:t}=await Gt.get("/x/web-interface/nav",{retry:3,headers:{Origin:xt}});return t}async function ae(){const{data:t}=await Gt.get("/x/web-interface/coin/today/exp");return t}function se(t){const e=t.level_info,n=e.current_level;if(n>=Q.BILI_TARGET_LEVEL&&(F.coinsTask=0),C.info(`当前等级: ${e.current_level}`),n>=6)ee.shareAndWatch=!1,ee.addCoins=!1,C.info("已经满级，不需要再投币了，做个白嫖怪吧");else{const t=e.next_exp-e.current_exp;C.info(`距离升级还需要 ${t} 经验，预计 ${function(t){if(Q.BILI_TARGET_COINS<=0)return t/15;const e=10*Q.BILI_TARGET_COINS+15,n=t/e,i=F.money/(Q.BILI_TARGET_COINS-1);return n<i?Math.floor(n):(t-i*e)/25+i}(t).toFixed(2)} 天`)}}async function oe(t){try{var e;const{data:n}=await async function(){const{data:t}=await Bt.get("/site/getCoin");return t}();C.info(`登录成功: ${t.uname}`),C.info(`硬币余额: ${n.money||0}`),Q.NICKNAME=function(t){const e=t.length;return e<=3?t:`${t[0]}**${t[e-1]}`}(t.uname),F.money=n.money||0,F.bCoinCouponBalance=(null===(e=t.wallet)||void 0===e?void 0:e.coupon_balance)||0,se(t),function(t){let e="";switch(F.vipType=t.vipType,t.vipType){case 0:e="无大会员";break;case 1:e="月度大会员";break;case 2:e="年度大会员"}0===t.vipStatus&&(e="无大会员"===e?e:e+"[已过期]"),C.info(`大会员状态: ${e}`)}(t)}catch(t){C.error(`获取硬币信息异常: ${t.message}`)}}async function re(t,e=12,n=1){try{const{data:i}=await Gt.get("/x/space/article",{params:{callback:"__test",jsonp:"jsonp",sort:"publish_time",pn:n,ps:e,mid:t}});return function(t){const e=t.replace(/^\w+\(/,"").replace(/\)$/,"");return JSON.parse(e)}(i)}catch(t){console.log(t)}}async function ce(t,e,n=1){const{data:i}=await Gt.post("/x/web-interface/coin/add",u.stringify({aid:t,multiply:e,selectLike:n,csrf:Q.BILIJCT}));return i}async function ue(t,e=1){const{data:n}=await T.default.post("https://www.bilibili.com/audio/music-service-c/web/coin/add",u.stringify({sid:t,multiply:e,csrf:Q.BILIJCT}));return n}const de="video",fe="audio",le="article";async function pe(t=!0){try{const e=Q.USERID;let n;n=t?await async function(t=1,e=50){const{data:n}=await Gt.get("/x/relation/tag",{params:{tagid:-10,pn:t,ps:e}});return n}():await async function(t,e=1,n=50,i="desc",a="attention"){const{data:s}=await Gt.get("/x/relation/followings",{params:{vmid:t,pn:e,ps:n,order:i,order_type:a}});return s}(e);const{data:i,message:a,code:s}=n;if(0===s&&i.length>0){await Ot();const{mid:t}=i[O(i.length-1)];return await me(t)}return 0===i.length?{msg:"-1",data:{}}:{msg:t?`未获取到特别关注列表: ${s}-${a}`:`未获取到关注列表: ${s}-${a}`,data:{}}}catch(t){return{msg:t.message,data:{}}}}async function ge(){const t=[1,3,4,5,160,22,119],e=t[O(t.length-1)];try{const{data:t,message:n,code:i}=await async function(t=1,e=3){const{data:n}=await Gt.get("/x/web-interface/ranking/region",{params:{rid:t,day:e}});return n}(e,3);if(0==i){const{aid:e,title:n,author:i}=t[O(t.length-1)];return{msg:"0",data:{id:Number(e),title:n,author:i}}}return{msg:`未获取到排行信息: ${i}-${n}`,data:{}}}catch(t){return{msg:t.message,data:{}}}}async function he(){const t=Q.BILI_CUSTOMIZE_UP;if(0===t.length)return{msg:"-1",data:{}};const e=t[O(t.length-1)];return await me(e)}async function me(t){try{const{code:e,data:n,message:i}=await async function(t){const{data:e}=await Gt.get(`/x/space/navnum?mid=${t}`);return e}(t);if(e)return{msg:`通过uid获取视频失败: ${e}-${i}`,data:{}};await Ot();const{video:a,audio:s,article:o}=n,{type:r,page:c,index:u}=function([t,e,n]){const i=t+e+n;if(!i)return;const a=O(0,i-1);let s=a;if(a<t)return{type:de,page:I(30,s+1),index:s%30};const o=t+e;return s=a-t,a<o?{type:fe,page:I(30,s+1),index:s%30}:(s=a-o,{type:le,page:I(12,s+1),index:s%12})}([a,s,o]),d={[de]:_e,[fe]:ye,[le]:we},f=await d[r](t,c,u);return f.message?{msg:f.message,data:{}}:{msg:"0",data:f}}catch(t){return C.debug(t),{msg:t.message,data:{}}}}async function _e(t,e,n){const{code:i,data:a,message:s}=await async function(t,e=30,n=1,i=""){const{data:a}=await Gt.get("/x/space/arc/search",{params:{jsonp:"jsonp",order:"pubdate",keyword:i,pn:n,tid:0,ps:e,mid:t}});return a}(t,30,e);if(i)return{message:s};const{aid:o,title:r,author:c}=a.list.vlist[n];return{type:de,id:o,title:r,author:c}}async function ye(t,e,n){const{code:i,data:a,msg:s}=await async function(t,e=30,n=1){const{data:i}=await Gt.get("/audio/music-service/web/song/upper",{params:{jsonp:"jsonp",order:1,pn:n,ps:e,uid:t}});return i}(t,30,e);if(i)return{message:s};const{data:o}=a,{id:r,uname:c,title:u}=o[n];return{type:fe,id:r,title:u,author:c}}async function we(t,e,n){const{code:i,data:a,message:s}=await re(t,12,e);if(i)return{message:s};const{articles:o}=a,{id:r,title:c,author:{name:u}}=o[n];return{type:le,id:r,title:c,author:u,mid:t}}async function ve(){let t;const e=[he,pe,()=>pe(!1),ge];Q.BILI_CUSTOMIZE_UP||e.shift(),e.splice(0,F.currentStartFun);for(let n=0;n<e.length;n++){const i=e[n];if(t=await i(),"0"===t.msg)return t;let a=Number(Q.BILI_COIN_RETRY_NUM??4);for(a=a<1?1:a>8?8:a;a--;)if(await Ot(),t=await i(),"-1"===t.msg&&(a=0),"0"===t.msg)return t;a<=0&&(F.currentStartFun=n)}return{msg:"-1",data:{id:0}}}async function $e({id:t,coin:e=1,type:n="video",mid:i}){const a={[de]:ce,[fe]:ue,[le]:(t,e=1)=>async function(t,e,n=1){const{data:i}=await Gt.post("/x/web-interface/coin/add",u.stringify({aid:e,upid:t,avtype:2,multiply:n,csrf:Q.BILIJCT}));return i}(i,t,e)},s=await a[n](Number(t),e);return{code:s.code,message:s.message||s.msg}}async function Te(t,e){const{data:n}=await Ht.get("/link_setting/v1/link_setting/sign_in",{params:{group_id:t,owner_id:e}});return n}async function be(){try{const{data:t,code:e,message:n}=await async function(){const{data:t}=await Ht.get("/link_group/v1/member/my_groups");return t}();return 0===e?(null==t?void 0:t.list)||[]:(C.warn(`获取自己的应援团异常失败: ${n}`),[])}catch(t){C.error(`获取自己的应援团异常: ${t}`)}}const Se=["棒","棒唉","棒耶","加油~","UP加油!","支持~","支持支持！","催更啦","顶顶","留下脚印~","干杯","bilibili干杯","o(*￣▽￣*)o","(｡･∀･)ﾉﾞ嗨","(●ˇ∀ˇ●)","( •̀ ω •́ )y","(ง •_•)ง",">.<","^_~"],Ie=["(⌒▽⌒)","（￣▽￣）","(=・ω・=)","(｀・ω・´)","(〜￣△￣)〜","(･∀･)","(°∀°)ﾉ","(￣3￣)","╮(￣▽￣)╭","_(:3」∠)_","( ´_ゝ｀)","←_←","→_→","(<_<)","(>_>)","(;¬_¬)","(ﾟДﾟ≡ﾟдﾟ)!?","Σ(ﾟдﾟ;)","Σ( ￣□￣||)","(´；ω；`)","（/TДT)/","(^・ω・^ )","(｡･ω･｡)","(●￣(ｴ)￣●)","ε=ε=(ノ≧∇≦)ノ","(´･_･`)","(-_-#)","（￣へ￣）","(￣ε(#￣) Σ","ヽ(`Д´)ﾉ","（#-_-)┯━┯","(╯°口°)╯(┴—┴","←◡←","( ♥д♥)","Σ>―(〃°ω°〃)♡→","⁄(⁄ ⁄•⁄ω⁄•⁄ ⁄)⁄","(╬ﾟдﾟ)▄︻┻┳═一","･*･:≡(　ε:)","(汗)","(苦笑)"].concat("1","2","3","4","5","6","7","8","9","签到","哈哈");async function Oe(){try{const{code:t,message:e,data:n}=await async function(t=1,e=256,n=1){const{data:i}=await Dt.get(`/xlive/app-ucenter/v1/fansMedal/panel?page=${t}&page_size=${e}&target_id=${n}`);return i}(1,256,Q.USERID);return 0!==t?(C.verbose(`获取勋章信息失败 ${t} ${e}`),null):n}catch(t){return C.error(`获取勋章异常 ${t.message}`),null}}async function Ee(t,e){const n=Ie[O(Ie.length-1)];try{const{code:i,message:a}=await async function(t,e){const n=Q.BILIJCT,i=n;e||(e=O(10).toString());const{data:a}=await Dt.post("/msg/send",u.stringify({color:5566168,fontsize:25,mode:1,msg:e,rnd:Date.now(),roomid:t,bubble:0,csrf:n,csrf_token:i}));return a}(t,n);return 0===i||(11e3===i?(C.warn(`【${e}】${t}-可能未开启评论`),!1):(C.warn(`【${e}】${t}-发送失败 ${a}`),C.verbose(`code: ${i}`),!1))}catch(t){C.verbose(`发送弹幕异常 ${t.message}`)}}async function Ce(){try{const{data:t,message:e,code:n}=await ie();if(0!==n)return void C.warn(`获取用户信息失败：${n} ${e}`);!function(t){var e;F.bCoinCouponBalance=(null===(e=t.wallet)||void 0===e?void 0:e.coupon_balance)||0}(t)}catch(t){C.error(`获取用户信息异常：${t.message}`)}}var xe;async function Ne(t){try{const e=function(t){switch(t){case 1:return"B 币券";case 2:return"大会员优惠券";default:return""}}(t),{code:n,message:i}=await async function(t=1){const{data:e}=await Gt.post("/x/vip/privilege/receive",u.stringify({csrf:Q.BILIJCT,type:t}));return e}(t);let a="成功";return 0===n&&(a=`失败 ${i}`),C.info(`领取${e} ${a}`),!0}catch(t){C.error(`领取权益出现异常：${t.message}`)}return!1}async function Ae(t){let e=0,n=!1;for(;!(n||(n=await Ne(t),e>2));)e++;return n}!function(t){t[t["成功"]=4]="成功",t[t["低于20电池"]=-2]="低于20电池",t[t["B币不足"]=-4]="B币不足"}(xe||(xe={}));const{BILI_GIFT_UP:Pe}=Q;let ke=0;async function Le(){try{const{data:{list:t}}=await Kt();return t.filter((t=>!![1,30607].includes(t.gift_id)&&(1e3*t.expire_at-(new Date).getTime())/X.MS2DATE<2))}catch(t){if(ke)return null;await Le(),ke++}}async function Re(t){try{const{data:{live_room:e}}=await async function(t){const{data:e}=await Gt.get(`/x/space/acc/info?mid=${t}&jsonp=jsonp`);return e}(t);if(await Ot(),e.roomStatus)return{roomid:e.roomid}}catch{}return{roomid:0}}const Ue=Q.BILIJCT,Be=Ue;async function De(t,e,n,i){const a=u.stringify({is_fav:0,main_id:e,oid:t,detail_id:n,count:i,csrf:Ue,csrf_token:Be}),{data:s}=await Gt.post("/x/esports/guess/add",a);return s}const{MATCH_SELECTION:Ge,MATCH_COINS:Me}=Q;function He(){return F.money-Me<Q.BILI_TARGET_COINS&&(C.info(`需要保留${Q.BILI_TARGET_COINS}个硬币，任务结束`),!0)}var Ke={taskReward:async function(){C.info("----【每日任务完成情况】----");try{const{data:t,message:e,code:n}=await async function(){const{data:t}=await Gt.get("/x/member/web/exp/reward");return t}();await Ot();const{data:i}=await ae();if(0!=n)return void C.warn(`状态获取失败: ${n} ${e}`);const a=F.money-Q.BILI_STAY_COINS;let s=0;0===F.coinsTask?C.info(`今日投币获取经验: ${i}，还需投币0颗，经验够了，不想投了`):a<=0?C.info(`今日投币获取经验: ${i}，还需投币0颗，硬币不够了，不投币了`):a<F.coinsTask?(s=F.coinsTask-a,C.info(`投币获取经验: ${i}，还需投币数量: ${s}颗;(目标${F.coinsTask}颗，忽略部分投币)`)):(s=F.coinsTask-i/10,C.info(`投币获取经验: ${i}，还需投币数量: ${s}颗;(目标${F.coinsTask}颗)`)),F.coinsTask=s,C.info("每日分享: "+(t.share?"已完成":"[未完成]")),C.info("每日播放: "+(t.watch?"已完成":"[未完成]")),F.share=t.share,F.watch=t.watch}catch(t){C.error(`状态获取异常 ${t.message}`)}},liveSignTask:async function(){C.info("----【直播签到】----");try{const{data:t}=await async function(){const{data:t}=await Dt.get("/xlive/web-ucenter/v1/sign/WebGetSignInfo");return t}();if(1===t.status)return C.info("已签到，跳过签到"),void C.info(`已经签到${t.hadSignDays}天，${t.specialText}`)}catch(t){}try{const{code:t,data:e,message:n}=await async function(){const{data:t}=await Dt.get("/xlive/web-ucenter/v1/sign/DoSign");return t}();0===t?C.info(`直播签到成功: ${e.text}，特别信息: ${e.specialText}，本月签到天数: ${e.hadSignDays}天;`):C.warn(`直播签到失败: ${t} ${n}`)}catch(t){C.error(`直播签到异常: ${t.message}`)}},shareAndWatch:async function(){if(C.info("----【分享/播放视频】----"),F.share&&F.watch)return void C.info("已完成，跳过分享/播放");let t=0;try{let e=await he();if("-1"===e.msg&&(e=await ge()),"0"!==e.msg)return C.warn(`获取视频失败 ${e.msg}`),!1;{const{id:n,author:i,title:a}=e.data;t=n,C.info(`获取视频: ${a} --up【${i}】`)}}catch(t){return C.error(`获取视频出现异常: ${t.message}`),!1}if(!F.share){await Ot();try{const{code:e,message:n}=await async function(t){const e={csrf:Q.BILIJCT,aid:t},{data:n}=await Gt.post("/x/web-interface/share/add",u.stringify(e));return n}(t);0===e?C.info("分享视频成功!"):C.warn(`分享视频失败: ${e} ${n}`)}catch(t){C.error(`分享视频异常: ${t.message}`)}}if(!F.watch){await Ot();try{const{code:e,message:n}=await async function(t,e){const{data:n}=await Gt.post("/x/click-interface/web/heartbeat",u.stringify({aid:t,played_time:e}));return n}(t,O(4,60));0===e?C.info("播放视频成功!"):C.warn(`播放视频失败: ${e} ${n}`)}catch(t){C.error(`播放视频异常: ${t.message}`)}}},silver2Coin:async function(){C.info("----【银瓜子兑换硬币】----");try{const{data:t,code:e,message:n}=await async function(){const{data:t}=await Dt.get("/xlive/revenue/v1/wallet/getStatus");return t}();if(0!=e&&C.info(`获取瓜子详情失败 ${n}`),0===t.silver_2_coin_left)C.info("今日已兑换一次");else if(t.silver<700)C.info("兑换失败，你瓜子不够了");else{const{message:t}=await async function(){const{data:t}=await Dt.post("/xlive/revenue/v1/wallet/silver2coin",u.stringify({csrf_token:Q.BILIJCT,csrf:Q.BILIJCT}));return t}();C.info(t),await async function(){const{data:t}=await Dt.get("/xlive/revenue/v1/wallet/myWallet?need_bp=1&need_metal=1&platform=pc");return t}()}}catch(t){C.error(`操作异常 ${t.message}`)}},addCoins:async function(){if(C.info("----【视频投币】----"),!F.coinsTask)return void C.info("跳过投币，今日已完成");let t,e=0,n=0;for(;F.coinsTask&&n<5;){try{const{data:t,code:e}=await ae();if(0==e){const e=Q.BILI_TARGET_COINS-t/10;F.coinsTask=e>0?e:0}}catch(t){}if(F.coinsTask<=0||F.money<=0)break;const{data:i,msg:a}=await ve();if(null==i||!i.id||"0"!=a){n++;continue}await Ot();const{id:s,title:o,author:r,type:c,mid:u}=i;try{const i=await $e({id:s,type:c,mid:u});if(0===i.code)F.money--,F.coinsTask--,e++,C.info(`给[${o}--up【${r}】]投币成功`);else{if(n++,-111===i.code||-104===i.code){C.warn(`${s} ${i.message} 无法继续进行投币`);break}if(C.warn(`给up投币失败 ${i.code} ${i.message}`),t===i.code)break;t=i.code}}catch(t){n++,C.error(`投币异常 ${t.message}`)}finally{await Ot(1500)}}n>=5&&C.info("出现异常/错误5次，自动退出投币"),C.info(`一共成功投币${e}颗`),C.info(`硬币还剩${F.money}颗`)},mangaSign:async function(){C.info("----【漫画签到】----");try{const{code:t}=await async function(t="android"){const{data:e}=await Mt.post("/twirp/activity.v1.Activity/ClockIn",u.stringify({platform:t}));return e}();0==t?C.info("漫画签到成功"):C.warn("漫画签到失败")}catch(t){400===t.response.status?C.info("已经签到过了，跳过任务"):C.error(`漫画签到异常 ${t.message}`)}},supGroupSign:async function(){C.info("----【应援团签到】----");const t=await be();await Ot();let e=0;for(let n=0;n<t.length;){const i=t[n];try{const{data:t,code:n,message:a}=await Te(i.group_id,i.owner_uid);0===n?0===t.status?e++:C.info(a):C.warn(`[${i.group_name}]签到失败 ${a}`)}catch(t){C.error(`签到异常 ${t.message}`)}finally{await Ot()}}C.info(`签到结束，成功${e}/${t.length}`)},liveSendMessage:async function(){C.info("----【发送直播弹幕】----");const t=await async function(){const{list:t,special_list:e}=await Oe();return t.push(...e),t}(),e=t.length;let n=0,i=0;C.info(`一共需要发送${e}个直播间`),C.verbose("所需时间可能很长，请耐心等待");for(let a=0;a<e;a++){const{room_info:s,anchor_info:o,medal:r}=t[a];null!=s&&s.room_id?100!==r.today_feed?(await Ee(s.room_id,o.nick_name)&&n++,a<e-1&&await Ot(O(1e4,25e3))):i++:(C.info(`【${o.nick_name}】没有直播间哦`),i++)}C.info(`成功发送${n}个弹幕，跳过${i}个`)},charging:async function(){if(C.info("----【给目标充电】----"),await Ce(),await Ot(),function(){const t=S(),e=t.getDate(),n=b(t),i=Q.CHARGE_PRESET_TIME;return F.bCoinCouponBalance<2?(C.info(`剩余券为${F.bCoinCouponBalance}，不足2跳过充电`),!1):n===e?(C.info("今天是最后一天了"),!0):!(i>e&&(C.info(`预设时间为${i}，不符合条件`),1))}())try{const t=F.bCoinCouponBalance||0,e=Q.CHARGE_ID;let n=0;C.info(`b 币券余额${t}`);const i=async()=>{const{code:n,message:i,data:a}=await async function(t=50,e=!0,n=Q.USERID,i="up",a=n){const{data:s}=await Gt.post("/x/ugcpay/web/v2/trade/elec/pay/quick",u.stringify({csrf:Q.BILIJCT,bp_num:t,is_bp_remains_prior:e,up_mid:n,otype:i,oid:a}));return s}(t,!0,e);0===n?(C.info(`【充值结果】${xe[a.status]}`),a.status===xe["成功"]&&(F.chargeOrderNo=a.order_no,await Ot(),await async function(){try{if(!F.chargeOrderNo)return!1;const t=Se[O(0,Se.length-1)],{code:e}=await async function(t,e="支持大佬一波"){const{data:n}=await Gt.post("/x/ugcpay/trade/elec/message",u.stringify({csrf:Q.BILIJCT,message:e,order_id:t}));return n}(F.chargeOrderNo,t);0===e&&C.info("留言成功！")}catch{}}())):C.warn(`充电失败：${n} ${i}`)};for(F.chargeOrderNo="";!(F.chargeOrderNo||(await i(),await Ot(),n++>2)););}catch(t){C.error(`充电出现异常：${t.message}`)}},getVipPrivilege:async function(){C.info("----【领取大会员权益】----"),function(){if(2!==F.vipType)return C.info("账号非年度大会员，不需要领取权益"),!1;const t=S(),e=t.getDate(),n=b(t);return 1===e||n===e||(C.info("今天非预订领取时间，跳过领取"),!1)}()&&(await Ae(1),await Ae(2))},giveGift:async function(){C.info("----【投喂过期食物】----");try{const t=await Le();if(await Ot(),null==t||!t.length)return void C.info("没有2天内过期的简单礼物");const{roomid:e,mid:n}=await async function(){const t=Object.assign([],Pe),e=()=>t.splice(O(Pe.length-1),1)[0];for(;t.length;){const t=e(),{roomid:n}=await Re(t);if(n)return{roomid:n,mid:t}}return await async function(){const{data:{count:t,items:e}}=await jt();if(await Ot(),!t)return{roomid:0,mid:0};const n=e[O(e.length-1)];return{mid:n.target_id,roomid:(null==n?void 0:n.roomid)||0}}()}();if(!e)return void C.info("没有找到投喂目标");await async function({roomid:t,mid:e},n){for(const i of n){await Ot();try{const{code:n,message:a,data:s}=await qt({roomid:t,ruid:e,bag_id:i.bag_id,gift_id:i.gift_id,gift_num:i.gift_num});0!==n?C.warn(`给[ ${s.uname} ]投喂${s.gift_name}: ${a}`):C.info(`成功给[ ${s.uname} ]投喂${s.gift_num}${s.gift_name}`)}catch{}}}({roomid:e,mid:n},t)}catch(t){C.info(`投喂过期食物异常 ${t}`)}},matchGame:async function(){if(C.info("----【赛事硬币竞猜】----"),Me<=0)return void C.info("硬币数量不能小于 0");if(He())return;const t=await async function(){try{const{code:t,message:e,data:{list:n,page:i}}=await async function(t="",e=""){const{data:n}=await Gt.get(`/x/esports/guess/collection/question?pn=1&ps=50&gid=&sids=&stime=${t}&etime=${e}`);return n}();return 0!==t?void C.warn(`获取赛事错误 ${t} ${e}`):0===i.total?(C.info("今日已经无法获取赛事"),null):n}catch(t){}}();if(await Ot(),!t)return;const e=await async function(t){let e=0;try{for(const n of t){const{contest:t,questions:i}=n,a=t.id,[{id:s,title:o,details:r,is_guess:c}]=i,[u,d]=r;if(He())return e;if(c)continue;C.info(`${o} <=> ${u.odds}:${d.odds}`);const f=u.odds>d.odds;let l;l=Ge>0?f?d:u:f?u:d,C.info(`预测[ ${l.option} ] ${Me} 颗硬币`),await Ot();const{code:p}=await De(a,s,l.detail_id,Me);0!==p?C.info("预测失败"):(e++,F.money-=Me)}}catch(t){console.warn(t.message)}return e}(function(t,e){return t.filter((t=>{const{questions:n}=t,[{details:i,is_guess:a}]=n;if(a)return!1;const[s,o]=i;return Math.abs(s.odds-o.odds)>=e}))}(t,Q.MATCH_DIFF));C.info(`【竞猜结束】一共参与${e}次预测`)}};async function je(t,...e){try{await async function(){C.info("----【登录】----");try{const{data:t,message:e,code:n}=await ie();if(65006===n||-404===n)return void C.error(`登录错误 ${n} ${e}`);if(0!==n)return void C.error(`登录错误 ${n} ${e}`);if(!t.isLogin)throw new Error("接口返回为未登录");await Ot(),await oe(t)}catch(t){throw new Error(t.message)}}()}catch(t){return C.error(`登录失败: ${t}`),await It("登录失败",E.value),"未完成"}const n=ne([...Object.values(Ke)]);for(const t of n)await t(),await Ot();return t&&await t(...e),await It("每日完成",E.value),"完成"}!async function(){(function(){try{const t=h.readFileSync(p.resolve(__dirname,"../version.txt"),"utf8").trim();t&&C.info(`当前版本【${t}】`)}catch{}})(),Q.config.function.liveHeart?await je(Vt):await je()}();
