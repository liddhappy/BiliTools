"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("path"),e=require("pako"),n=require("fs"),i=require("querystring"),a=require("nodemailer"),s=require("got"),o=require("tough-cookie"),r=require("tunnel"),c=require("tencentcloud-sdk-nodejs"),u=require("crypto"),d=require("qs"),f=require("axios");function l(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}function g(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(n){if("default"!==n){var i=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,i.get?i:{enumerable:!0,get:function(){return t[n]}})}})),e.default=t,Object.freeze(e)}var p=g(t),h=g(e),m=g(n),_=g(i),y=g(a),w=g(s),v=g(o),$=g(r),T=g(u),S=l(f);function b(t){const e=t||E(),n=e.getFullYear(),i=e.getMonth()+1;return 2===i?n%4==0&&n%100!=0||n%400==0?29:28:[4,6,9,11].includes(i)?30:31}function E(){const t=new Date,e=t.getTime(),n=t.getTimezoneOffset()/60;return new Date(e+36e5*(n+8))}function I(t,e){return Math.ceil(e/t)}function O(t=6e4){t=t||6e4;const e=E().getTime()+t,n=new Date(e),i=n.getSeconds(),a=n.getMinutes(),s=n.getHours();return{value:`${i} ${a} ${s} * * * *`,string:`${s}:${a}:${i}`}}function C(t,e,n){if(n&&"boolean"!=typeof n&&(e=n=void 0),void 0===n&&("boolean"==typeof e?(n=e,e=void 0):"boolean"==typeof t&&(n=t,t=void 0)),void 0===t&&void 0===e?(t=0,e=1):void 0===e&&(e=t,t=0),t>e){const n=t;t=e,e=n}if(n||t%1||e%1){const n=Math.random();return Math.min(t+n*(e-t+parseFloat("1e-"+((n+"").length-1))),e)}return t+Math.floor(Math.random()*(e-t+1))}const N={value:""},x={log:A,error:function(t){A("error",t)},warn:function(t){A("warn",t)},info:function(t){A("info",t)},verbose:function(t){A("verbose",t)},debug:function(t){A("debug",t)}};function A(t,e){const n=E().toString().match(/\w{2}:\w{2}:\w{2}/)[0];if(function(t="debug"){const e=["error","warn","info","verbose","debug"],n=e.indexOf(t);return n>0?e.slice(0,n+1):e}().includes(t)){const t=`[${n}] ${e}`;N.value+=t+"\r\n"}console.log("[%s %s] %s",t,n,e)}const R=t=>{try{return Buffer.from(h.gzip(escape(t),{to:"string"}).toString(),"binary").toString("base64")}catch(t){return"Error: 当前字符串不能被Gzip加密"}},k=t=>{try{const e=Buffer.from(t,"base64").toString("binary").split("").map((t=>t.charCodeAt(0))),n=h.inflate(new Uint8Array(e)),i=String.fromCharCode.apply(null,new Uint16Array(n));try{return unescape(i)}catch(t){return i}}catch(t){throw new Error("Error: 当前字符串不能被Gzip解密")}},P=()=>"QingLong"===process.env.BARK_GROUP||"/ql"===process.env.QL_DIR;class D{static configFileName=function(){const t=P()?"cat_bili_config":"config",e=".json",{BILITOOLS_FILE_NAME:n}=process.env;return n?n.endsWith(e)?n:`${n}.json`:t+e}();static isQingLongPanel=P()}const L=t=>p.resolve(process.cwd(),t);function U(t){throw new Error(t||"配置文件不存（位置不正确）在或 cookie 不存在！！！")}const B=[()=>require(L("./config/config.dev.json")),()=>require(`./${D.configFileName}`),()=>require(L(`./config/${D.configFileName}`))],G=[()=>require("./config.json"),()=>require(L("./config/config.json"))];function M(t){const e=t.account.filter((t=>t.cookie));if(0===e.length)return;if(D.isQingLongPanel)return function(t){const e=process.argv.find((t=>t.includes("--item")||t.includes("-i")||t.includes("-I")));if(!e)return t[0];const n=Number(e.split("=")[1])-1;return!n||n>=t.length||n<0?(x.warn("似乎想要指定一个不存在的用户，我们将指定第一个用户"),t[0]):t[n]}(e);x.warn("在单用户场景下配置了多用户，我们将放弃多余的配置");const n=e[0];return n.message=Object.assign(t.message||{},n.message),n}const H=function(){let t,e=!1;D.isQingLongPanel&&B.splice(0,1,...G);for(const n of B)try{if(t=n(),t)break;e=!0}catch(t){const{message:n={}}=t;n.includes&&n.includes("in JSON at position")&&(e=!0);continue}if(t||(t=(()=>{const{BILITOOLS_CONFIG:t,BILI_SCF_CONFIG:e,BILI_CONFIG:n}=process.env,i=t||e||n;if(i)try{return JSON.parse(k(i))}catch{U("环境中的配置不是有效的 JSON 字符串！")}})()),t||(e&&U("配置文件存在，但是无法解析！可能 JSON 格式不正确！"),U()),t.account&&t.account.length){const e=M(t);if(e)return e}return t.cookie||U(),t}(),{cookie:K}=H;function q(t){return t?t.split("; ").map((t=>t.split("="))):[]}function j(t,e){return t?e&&0!==e.length?function(t){const e=Object.keys(t).reduce(((e,n)=>e+`${n}=${t[n]}; `),"");return e.substring(0,e.length-2||0)}(function(t,e){const n=q(null==e?void 0:e[0]).filter((t=>2===t.length)),i=q(t).concat(n).filter((t=>2===t.length)),a={};for(const t of i)a[t[0]]?a[t[0]]=t[1]:Object.defineProperty(a,t[0],{value:t[1],enumerable:!0,writable:!0});return a}(t,e)):t:""}function J(t,e){if(!t)return null;const n=`(?:^|)${e}=([^;]*)(?:;|$)`,i=t.match(n);return i?i[1]:null}function Y(){return J(K,"bili_jct")||""}function F(){return J(K,"LIVE_BUVID")||""}var Q,X,W,z,V,Z,tt,et;function nt(t){return null==t?void 0:t.map((t=>Number(t)))}class it{static config=H;static COOKIE=H.cookie;static BILIJCT=Y();static NICKNAME="";static USERID=function(){return Number(J(K,"DedeUserID"))||0}();static USER_AGENT=H.userAgent;static BILI_TARGET_COINS=null!==(Q=H.targetCoins)&&void 0!==Q?Q:5;static biliApiDelay=H.apiDelay||[2,6];static BILI_API_DELAY=Array.isArray(it.biliApiDelay)?it.biliApiDelay:[it.biliApiDelay];static BILI_CUSTOMIZE_UP=nt(H.customizeUp)||[];static BILI_GIFT_UP=nt(H.giftUp)||it.BILI_CUSTOMIZE_UP||[];static BILI_TARGET_LEVEL=null!==(X=H.targetLevel)&&void 0!==X?X:6;static BILI_STAY_COINS=null!==(W=H.stayCoins)&&void 0!==W?W:0;static BILI_UPPER_ACC_MATCH=H.upperAccMatch||!0;static BILI_COIN_RETRY_NUM=H.coinRetryNum||4;static CHARGE_ID=H.chargeUpId||it.USERID;static CHARGE_PRESET_TIME=H.chargePresetTime||31;static PUSHPLUS_TOKEN=process.env.PUSHPLUS_TOKEN||(null===(z=H.message)||void 0===z?void 0:z.pushplusToken);static MATCH_COINS=null!==(V=H.matchCoins)&&void 0!==V?V:5;static MATCH_SELECTION=null!==(Z=H.matchSelection)&&void 0!==Z?Z:1;static MATCH_DIFF=null!==(tt=H.matchDiff)&&void 0!==tt?tt:0;static MESSAGE_API=null===(et=H.message)||void 0===et?void 0:et.api}class at{static money=0;static coinsTask=it.BILI_TARGET_COINS;static share=!1;static watch=!1;static currentStartFun=0;static bCoinCouponBalance=0;static vipType=0}class st{static DAILY_TRIGGER_NAME="daily_bili_timer";static HEART_TRIGGER_NAME="heart_bili_timer";static DAILY_RUN_TIME="17:30:00-23:40:00";static HEART_RUN_TIME="12:00:00-20:00:00";static MS2DATE=864e5}!function(){var t;const e=(null===(t=it.config)||void 0===t?void 0:t.message)||{};it.PUSHPLUS_TOKEN&&(process.env.PUSH_PLUS_TOKEN=it.PUSHPLUS_TOKEN),["GOBOT_URL","GOBOT_TOKEN","GOBOT_QQ","SCKEY","QQ_SKEY","QQ_MODE","BARK_PUSH","BARK_SOUND","BARK_GROUP","TG_BOT_TOKEN","TG_USER_ID","TG_PROXY_AUTH","TG_PROXY_HOST","TG_PROXY_PORT","TG_API_HOST","DD_BOT_TOKEN","DD_BOT_SECRET","QYWX_KEY","QYWX_AM","IGOT_PUSH_KEY","PUSH_PLUS_TOKEN","PUSH_PLUS_USER"].forEach((t=>{const n=e[(i=t,i.toLowerCase().replace(/_(\w)/g,((t,e)=>e.toUpperCase())))]||e[t]||process.env[t];var i;n&&(process.env[t]=n)}))}();const ot=new function(t,e){return new class{constructor(t,e){this.name=t,this.data=null,this.dataFile="box.dat",this.logs=[],this.logSeparator="\n",this.startTime=(new Date).getTime(),Object.assign(this,e),this.log("",`🔔${this.name}, 开始!`)}isNode(){return"undefined"!=typeof module&&!!module.exports}isQuanX(){return"undefined"!=typeof $task}isSurge(){return"undefined"!=typeof $httpClient&&"undefined"==typeof $loon}isLoon(){return"undefined"!=typeof $loon}getScript(t){return new Promise((e=>{ot.get({url:t},((t,n,i)=>e(i)))}))}runScript(t,e){return new Promise((n=>{let i=this.getdata("@chavy_boxjs_userCfgs.httpapi");i=i?i.replace(/\n/g,"").trim():i;let a=this.getdata("@chavy_boxjs_userCfgs.httpapi_timeout");a=a?1*a:20,a=e&&e.timeout?e.timeout:a;const[s,o]=i.split("@"),r={url:`http://${o}/v1/scripting/evaluate`,body:{script_text:t,mock_type:"cron",timeout:a},headers:{"X-Key":s,Accept:"*/*"}};ot.post(r,((t,e,i)=>n(i)))})).catch((t=>this.logErr(t)))}loaddata(){if(!this.isNode())return{};{this.fs=this.fs?this.fs:require("fs"),this.path=this.path?this.path:require("path");const t=this.path.resolve(this.dataFile),e=this.path.resolve(process.cwd(),this.dataFile),n=this.fs.existsSync(t),i=!n&&this.fs.existsSync(e);if(!n&&!i)return{};{const i=n?t:e;try{return JSON.parse(this.fs.readFileSync(i))}catch(t){return{}}}}}writedata(){if(this.isNode()){this.fs=this.fs?this.fs:require("fs"),this.path=this.path?this.path:require("path");const t=this.path.resolve(this.dataFile),e=this.path.resolve(process.cwd(),this.dataFile),n=this.fs.existsSync(t),i=!n&&this.fs.existsSync(e),a=JSON.stringify(this.data);n?this.fs.writeFileSync(t,a):i?this.fs.writeFileSync(e,a):this.fs.writeFileSync(t,a)}}lodash_get(t,e,n){const i=e.replace(/\[(\d+)\]/g,".$1").split(".");let a=t;for(const t of i)if(a=Object(a)[t],void 0===a)return n;return a}lodash_set(t,e,n){return Object(t)!==t||(Array.isArray(e)||(e=e.toString().match(/[^.[\]]+/g)||[]),e.slice(0,-1).reduce(((t,n,i)=>Object(t[n])===t[n]?t[n]:t[n]=Math.abs(e[i+1])>>0==+e[i+1]?[]:{}),t)[e[e.length-1]]=n),t}getdata(t){let e=this.getval(t);if(/^@/.test(t)){const[,n,i]=/^@(.*?)\.(.*?)$/.exec(t),a=n?this.getval(n):"";if(a)try{const t=JSON.parse(a);e=t?this.lodash_get(t,i,""):e}catch(t){e=""}}return e}setdata(t,e){let n=!1;if(/^@/.test(e)){const[,i,a]=/^@(.*?)\.(.*?)$/.exec(e),s=this.getval(i),o=i?"null"===s?null:s||"{}":"{}";try{const e=JSON.parse(o);this.lodash_set(e,a,t),n=this.setval(JSON.stringify(e),i)}catch(e){const s={};this.lodash_set(s,a,t),n=this.setval(JSON.stringify(s),i)}}else n=ot.setval(t,e);return n}getval(t){return this.isSurge()||this.isLoon()?$persistentStore.read(t):this.isQuanX()?$prefs.valueForKey(t):this.isNode()?(this.data=this.loaddata(),this.data[t]):this.data&&this.data[t]||null}setval(t,e){return this.isSurge()||this.isLoon()?$persistentStore.write(t,e):this.isQuanX()?$prefs.setValueForKey(t,e):this.isNode()?(this.data=this.loaddata(),this.data[e]=t,this.writedata(),!0):this.data&&this.data[e]||null}initGotEnv(t){this.got=this.got?this.got:w,this.cktough=this.cktough?this.cktough:v,this.ckjar=this.ckjar?this.ckjar:new this.cktough.CookieJar,t&&(t.headers=t.headers?t.headers:{},void 0===t.headers.Cookie&&void 0===t.cookieJar&&(t.cookieJar=this.ckjar))}get(t,e=(()=>{})){t.headers&&(delete t.headers["Content-Type"],delete t.headers["Content-Length"]),this.isSurge()||this.isLoon()?$httpClient.get(t,((t,n,i)=>{!t&&n&&(n.body=i,n.statusCode=n.status),e(t,n,i)})):this.isQuanX()?$task.fetch(t).then((t=>{const{statusCode:n,statusCode:i,headers:a,body:s}=t;e(null,{status:n,statusCode:i,headers:a,body:s},s)}),(t=>e(t))):this.isNode()&&(this.initGotEnv(t),this.got(t).on("redirect",((t,e)=>{try{const n=t.headers["set-cookie"].map(this.cktough.Cookie.parse).toString();this.ckjar.setCookieSync(n,null),e.cookieJar=this.ckjar}catch(t){this.logErr(t)}})).then((t=>{const{statusCode:n,statusCode:i,headers:a,body:s}=t;e(null,{status:n,statusCode:i,headers:a,body:s},s)}),(t=>e(t))))}post(t,e=(()=>{})){if(t.body&&t.headers&&!t.headers["Content-Type"]&&(t.headers["Content-Type"]="application/x-www-form-urlencoded"),delete t.headers["Content-Length"],this.isSurge()||this.isLoon())$httpClient.post(t,((t,n,i)=>{!t&&n&&(n.body=i,n.statusCode=n.status),e(t,n,i)}));else if(this.isQuanX())t.method="POST",$task.fetch(t).then((t=>{const{statusCode:n,statusCode:i,headers:a,body:s}=t;e(null,{status:n,statusCode:i,headers:a,body:s},s)}),(t=>e(t)));else if(this.isNode()){this.initGotEnv(t);const{url:n,...i}=t;this.got.post(n,i).then((t=>{const{statusCode:n,statusCode:i,headers:a,body:s}=t;e(null,{status:n,statusCode:i,headers:a,body:s},s)}),(t=>e(t)))}}time(t){const e={"M+":(new Date).getMonth()+1,"d+":(new Date).getDate(),"H+":(new Date).getHours(),"m+":(new Date).getMinutes(),"s+":(new Date).getSeconds(),"q+":Math.floor(((new Date).getMonth()+3)/3),S:(new Date).getMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,((new Date).getFullYear()+"").substr(4-RegExp.$1.length)));for(const n in e)new RegExp("("+n+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?e[n]:("00"+e[n]).substr((""+e[n]).length)));return t}msg(e=t,n="",i="",a){const s=t=>!t||!this.isLoon()&&this.isSurge()?t:"string"==typeof t?this.isLoon()?t:this.isQuanX()?{"open-url":t}:void 0:"object"==typeof t&&(t["open-url"]||t["media-url"])?this.isLoon()?t["open-url"]:this.isQuanX()?t:void 0:void 0;ot.isMute||(this.isSurge()||this.isLoon()?$notification.post(e,n,i,s(a)):this.isQuanX()&&$notify(e,n,i,s(a))),this.logs.push("","==============📣系统通知📣=============="),this.logs.push(e),n&&this.logs.push(n),i&&this.logs.push(i)}log(...t){t.length>0?this.logs=[...this.logs,...t]:x.info(this.logs.join(this.logSeparator))}logErr(t,e){!this.isSurge()&&!this.isQuanX()&&!this.isLoon()?ot.log("",`❗️${this.name}, 错误!`,t.stack):ot.log("",`❗️${this.name}, 错误!`,t)}wait(t){return new Promise((e=>setTimeout(e,t)))}done(t={}){const e=((new Date).getTime()-this.startTime)/1e3;this.log("",`🔔${this.name}, 结束! 🕛 ${e} 秒`),this.log(),(this.isSurge()||this.isQuanX()||this.isLoon())&&$done(t)}}(t,e)};let rt="",ct="",ut="",dt="QingLong",ft="",lt="",gt="",pt="",ht="",mt="api.telegram.org",_t="",yt="",wt="",vt="",$t="",Tt="",St="";async function bt(t,e){var n;const i=null===(n=it.config.message)||void 0===n?void 0:n.email;if(!(i&&i.pass&&i.from&&i.host))return;const a=Number(i.port)||465,s=y.createTransport({host:i.host,port:a,secure:465===a,auth:{user:i.from,pass:i.pass}}),o=await s.sendMail({from:`${t} <${i.from}>`,to:i.to,subject:t,headers:{"Content-Type":"text/plain; charset=utf-8"},text:e});x.info(`邮件消息已发送: ${o.messageId}`)}async function Et(t,e){try{const n=it.MESSAGE_API;if(!n)return;const i=n.replace("{title}",t).replace("{text}",e);await ot.get(i)}catch(t){}}function It(t,e,n=2100){return new Promise((i=>{if(rt){e=e.replace(/[\n\r]/g,"\n\n");const a={url:rt.includes("SCT")?`https://sctapi.ftqq.com/${rt}.send`:`https://sc.ftqq.com/${rt}.send`,body:`text=${t}&desp=${e}`,headers:{"Content-Type":"application/x-www-form-urlencoded"},timeout:15e3};setTimeout((()=>{ot.post(a,((t,e,n)=>{try{t?(x.info("发送通知调用API失败！！\n"),x.info(t)):0===(n=JSON.parse(n)).errno||0===n.data.errno?x.info("server酱发送通知消息成功🎉\n"):1024===n.errno?x.info(`server酱发送通知消息异常: ${n.errmsg}\n`):x.info(`server酱发送通知消息异常\n${JSON.stringify(n)}`)}catch(t){ot.logErr(t,e)}finally{i(n)}}))}),n)}else i("")}))}function Ot(t,e,n={}){return new Promise((i=>{if(ct){const a={url:`${ct}/${encodeURIComponent(t)}/${encodeURIComponent(e)}?sound=${ut}&group=${dt}&${_.stringify(n)}`,headers:{"Content-Type":"application/x-www-form-urlencoded"},timeout:15e3};ot.get(a,((t,e,n)=>{try{t?(x.info("Bark APP发送通知调用API失败！！\n"),x.info(t)):200===(n=JSON.parse(n)).code?x.info("Bark APP发送通知消息成功🎉\n"):x.info(`${n.message}\n`)}catch(t){ot.logErr(t,e)}finally{i("")}}))}else i("")}))}function Ct(t,e){return new Promise((n=>{if(ft&&lt){const i={url:`https://${mt}/bot${ft}/sendMessage`,body:`chat_id=${lt}&text=${t}\n\n${e}&disable_web_page_preview=true`,headers:{"Content-Type":"application/x-www-form-urlencoded"},timeout:15e3};if(gt&&pt){const t={https:$.httpsOverHttp({proxy:{host:gt,port:+pt,proxyAuth:ht}})};Object.assign(i,{agent:t})}ot.post(i,((t,e,i)=>{try{t?(x.info("telegram发送通知消息失败！！\n"),x.info(t)):(i=JSON.parse(i)).ok?x.info("Telegram发送通知消息成功🎉。\n"):400===i.error_code?x.info("请主动给bot发送一条消息并检查接收用户ID是否正确。\n"):401===i.error_code&&x.info("Telegram bot token 填写错误。\n")}catch(t){ot.logErr(t,e)}finally{n(i)}}))}else n("")}))}function Nt(t,e){return new Promise((n=>{const i={url:`https://oapi.dingtalk.com/robot/send?access_token=${_t}`,json:{msgtype:"text",text:{content:` ${t}\n\n${e}`}},headers:{"Content-Type":"application/json"},timeout:15e3};if(_t&&yt){const t=require("crypto"),e=Date.now(),a=t.createHmac("sha256",yt);a.update(`${e}\n${yt}`);const s=encodeURIComponent(a.digest("base64"));i.url=`${i.url}&timestamp=${e}&sign=${s}`,ot.post(i,((t,e,i)=>{try{t?(x.info("钉钉发送通知消息失败！！\n"),x.info(t)):0===(i=JSON.parse(i)).errcode?x.info("钉钉发送通知消息成功🎉。\n"):x.info(`${i.errmsg}\n`)}catch(t){ot.logErr(t,e)}finally{n(i)}}))}else _t?ot.post(i,((t,e,i)=>{try{t?(x.info("钉钉发送通知消息失败！！\n"),x.info(t)):0===(i=JSON.parse(i)).errcode?x.info("钉钉发送通知消息完成。\n"):x.info(`${i.errmsg}\n`)}catch(t){ot.logErr(t,e)}finally{n(i)}})):n("")}))}function xt(t,e){return new Promise((n=>{const i={url:`https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=${wt}`,json:{msgtype:"text",text:{content:` ${t}\n\n${e}`}},headers:{"Content-Type":"application/json"},timeout:15e3};wt?ot.post(i,((t,e,i)=>{try{t?(x.info("企业微信发送通知消息失败！！\n"),x.info(t)):0===(i=JSON.parse(i)).errcode?x.info("企业微信发送通知消息成功🎉。\n"):x.info(`${i.errmsg}\n`)}catch(t){ot.logErr(t,e)}finally{n(i)}})):n("")}))}function At(t){const e=vt.split(",");if(e[2]){const n=e[2].split("|");let i="";for(let e=0;e<n.length;e++){const a="签到号 "+(e+1);t.match(a)&&(i=n[e])}return i||(i=e[2]),i}return"@all"}function Rt(t,e){return new Promise((n=>{if(vt){const i=vt.split(","),a={url:"https://qyapi.weixin.qq.com/cgi-bin/gettoken",json:{corpid:`${i[0]}`,corpsecret:`${i[1]}`},headers:{"Content-Type":"application/json"},timeout:15e3};ot.post(a,((a,s,o)=>{const r=e.replace(/\n/g,"<br/>"),c=JSON.parse(o).access_token;let u;switch(i[4]){case"0":u={msgtype:"textcard",textcard:{title:`${t}`,description:`${e}`,url:"https://github.com/whyour/qinglong",btntxt:"更多"}};break;case"1":u={msgtype:"text",text:{content:`${t}\n\n${e}`}};break;default:u={msgtype:"mpnews",mpnews:{articles:[{title:`${t}`,thumb_media_id:`${i[4]}`,author:"智能助手",content_source_url:"",content:`${r}`,digest:`${e}`}]}}}i[4]||(u={msgtype:"text",text:{content:`${t}\n\n${e}`}}),u={url:`https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=${c}`,json:{touser:`${At(e)}`,agentid:`${i[3]}`,safe:"0",...u},headers:{"Content-Type":"application/json"}},ot.post(u,((t,i,a)=>{try{t?(x.info("成员ID:"+At(e)+"企业微信应用消息发送通知消息失败！！\n"),x.info(t)):0===(a=JSON.parse(a)).errcode?x.info("成员ID:"+At(e)+"企业微信应用消息发送通知消息成功🎉。\n"):x.info(`${a.errmsg}\n`)}catch(t){ot.logErr(t,i)}finally{n(a)}}))}))}else n("")}))}function kt(t,e,n={}){return new Promise((i=>{if($t){if(!new RegExp("^[a-zA-Z0-9]{24}$").test($t))return x.info("您所提供的IGOT_PUSH_KEY无效\n"),void i("");const a={url:`https://push.hellyw.com/${$t.toLowerCase()}`,body:`title=${t}&content=${e}&${_.stringify(n)}`,headers:{"Content-Type":"application/x-www-form-urlencoded"},timeout:15e3};ot.post(a,((t,e,n)=>{try{t?(x.info("发送通知调用API失败！！\n"),x.info(t)):("string"==typeof n&&(n=JSON.parse(n)),0===n.ret?x.info("iGot发送通知消息成功🎉\n"):x.info(`iGot发送通知消息失败：${n.errMsg}\n`))}catch(t){ot.logErr(t,e)}finally{i(n)}}))}else i("")}))}function Pt(t,e){return new Promise((n=>{if(Tt){e=e.replace(/[\n\r]/g,"<br>");const i={token:`${Tt}`,title:`${t}`,content:`${e}`,topic:`${St}`},a={url:"https://www.pushplus.plus/send",body:JSON.stringify(i),headers:{"Content-Type":" application/json"},timeout:15e3};ot.post(a,((t,e,i)=>{try{t?(x.info(`push+发送${St?"一对多":"一对一"}通知消息失败！！\n`),x.info(t)):200===(i=JSON.parse(i)).code?x.info(`push+发送${St?"一对多":"一对一"}通知消息完成。\n`):x.info(`push+发送${St?"一对多":"一对一"}通知消息失败：${i.msg}\n`)}catch(t){ot.logErr(t,e)}finally{n(i)}}))}else n("")}))}function Dt(){try{const t=m.readFileSync(p.resolve(__dirname,"../version.txt"),"utf8").trim();t&&x.info(`当前版本【${t}】`)}catch{}}async function Lt(t,e){x.info("----【消息推送】----"),t=`Bili-${it.NICKNAME}-${t}`,await async function(t,e,n={},i="\n\n本通知 By：https://github.com/catlair/BiliTools"){e+=i,await Promise.all([It(t,e),Pt(t,e)]),await Promise.all([Ot(t,e,n),Ct(t,e),Nt(t,e),xt(t,e),Rt(t,e),kt(t,e,n),bt(t,e),Et(t,e)])}(t,e,void 0,"")}function Ut(t){const e=it.BILI_API_DELAY;let n;n=1===e.length?1e3*e[0]:1e3*C(e[0]||2,e[1]||6),n=t||n;const i=(new Date).getTime()+parseInt(n,10);for(;(new Date).getTime()<i;);return new Promise((t=>{t("done")}))}process.env.PUSH_KEY&&(rt=process.env.PUSH_KEY),process.env.QQ_SKEY&&process.env.QQ_SKEY,process.env.QQ_MODE&&process.env.QQ_MODE,process.env.BARK_PUSH?(ct=process.env.BARK_PUSH.indexOf("https")>-1||process.env.BARK_PUSH.indexOf("http")>-1?process.env.BARK_PUSH:`https://api.day.app/${process.env.BARK_PUSH}`,process.env.BARK_SOUND&&(ut=process.env.BARK_SOUND),process.env.BARK_GROUP&&(dt=process.env.BARK_GROUP)):ct&&-1===ct.indexOf("https")&&-1===ct.indexOf("http")&&(ct=`https://api.day.app/${ct}`),process.env.TG_BOT_TOKEN&&(ft=process.env.TG_BOT_TOKEN),process.env.TG_USER_ID&&(lt=process.env.TG_USER_ID),process.env.TG_PROXY_AUTH&&(ht=process.env.TG_PROXY_AUTH),process.env.TG_PROXY_HOST&&(gt=process.env.TG_PROXY_HOST),process.env.TG_PROXY_PORT&&(pt=process.env.TG_PROXY_PORT),process.env.TG_API_HOST&&(mt=process.env.TG_API_HOST),process.env.DD_BOT_TOKEN&&(_t=process.env.DD_BOT_TOKEN,process.env.DD_BOT_SECRET&&(yt=process.env.DD_BOT_SECRET)),process.env.QYWX_KEY&&(wt=process.env.QYWX_KEY),process.env.QYWX_AM&&(vt=process.env.QYWX_AM),process.env.IGOT_PUSH_KEY&&($t=process.env.IGOT_PUSH_KEY),process.env.PUSH_PLUS_TOKEN&&(Tt=process.env.PUSH_PLUS_TOKEN),process.env.PUSH_PLUS_USER&&(St=process.env.PUSH_PLUS_USER);const Bt=c.scf.v20180416.Client,{DAILY_RUN_TIME:Gt,DAILY_TRIGGER_NAME:Mt}=st;async function Ht(t=Mt,e,n,i=2){var a;if(!H.sls)return!1;const s=null===(a=H.sls)||void 0===a?void 0:a.name,o={credential:{secretId:process.env.TENCENT_SECRET_ID,secretKey:process.env.TENCENT_SECRET_KEY},region:H.sls.region,profile:{httpProfile:{endpoint:"scf.tencentcloudapi.com"}}},r=new Bt(o);async function c(){const i=n||function(t=Gt){var e,n;const i=t.split("-"),a=i[0].split(":").map((t=>+t)),s=i[1].split(":").map((t=>+t)),o=C(null!==(e=a[0])&&void 0!==e?e:19,null!==(n=s[0])&&void 0!==n?n:23);let r=0;r=o==a[0]?C(a[1],59):o==s[0]?C(s[1]):C(59);let c=0;return c=o==a[0]?C(a[2],59):o==s[0]?C(s[2]):C(59),{value:`${c} ${r} ${o} * * * *`,string:`${o}:${r}:${c}`}}(H.dailyRunTime),a={FunctionName:s,TriggerName:t,Type:"timer",TriggerDesc:i.value,Qualifier:"$DEFAULT"},o=await async function(t){try{const{Triggers:e}=await r.ListTriggers({FunctionName:s});return-1!==(null==e?void 0:e.findIndex((e=>e.TriggerName===t)))}catch({code:t,message:e}){return x.error(`获取trigger失败 ${t} => ${e}`),!1}}(t);if(x.info(`修改时间为：${i.string}`),o){const t=await async function(t){try{return await r.DeleteTrigger(t)}catch({code:t,message:e}){return x.warn(`删除trigger失败 ${t} => ${e}`),!1}}(a);if(!t)return}return!!await async function(t){const n=E();t.CustomArgument=JSON.stringify({...e,lastTime:n.getDate().toString()});try{return await r.CreateTrigger(t)}catch({code:t,message:e}){return x.error(`创建trigger失败 ${t} => ${e}`),!1}}(a)}if(!process.env.TENCENT_SECRET_ID||!process.env.TENCENT_SECRET_KEY)return x.info("环境变量不存在TENCENT_SECRET_ID和TENCENT_SECRET_KEY"),!1;let u=!1;for(;!u&&i;)u=await c(),i--;return u}const Kt={"User-Agent":it.USER_AGENT||"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.110 Safari/537.36 Edg/96.0.1054.62","content-type":"application/x-www-form-urlencoded","accept-language":"accept-language: zh-CN,zh;q=0.9,en-GB;q=0.8,en;q=0.7"};var qt;S.default.defaults.headers.common.Cookie=it.COOKIE,S.default.defaults.withCredentials=!0,S.default.defaults.headers.common["User-Agent"]=Kt["User-Agent"],S.default.defaults.headers.post["content-type"]=Kt["content-type"],S.default.defaults.headers.common["accept-language"]=Kt["accept-language"],function(t){t[t["应用程序不存在或已被封禁"]=-1]="应用程序不存在或已被封禁",t[t["Access Key错误"]=-2]="Access Key错误",t[t["API校验密匙错误"]=-3]="API校验密匙错误",t[t["调用方对该Method没有权限"]=-4]="调用方对该Method没有权限",t[t["账号未登录"]=-101]="账号未登录",t[t["账号被封停"]=-102]="账号被封停",t[t["积分不足"]=-103]="积分不足",t[t["硬币不足"]=-104]="硬币不足",t[t["验证码错误"]=-105]="验证码错误",t[t["账号非正式会员或在适应期"]=-106]="账号非正式会员或在适应期",t[t["应用不存在或者被封禁"]=-107]="应用不存在或者被封禁",t[t["未绑定手机?"]=-108]="未绑定手机?",t[t["未绑定手机"]=-110]="未绑定手机",t[t["csrf 校验失败"]=-111]="csrf 校验失败",t[t["系统升级中"]=-112]="系统升级中",t[t["账号尚未实名认证"]=-113]="账号尚未实名认证",t[t["请先绑定手机"]=-114]="请先绑定手机",t[t["请先完成实名认证"]=-115]="请先完成实名认证"}(qt||(qt={}));const jt="https://account.bilibili.com",Jt="https://live.bilibili.com",Yt="https://www.bilibili.com/",Ft="https://account.bilibili.com",Qt="https://api.live.bilibili.com",Xt="https://api.bilibili.com",Wt="https://manga.bilibili.com",zt="https://api.vc.bilibili.com";S.default.interceptors.response.use((t=>{var e,n;const i=(null===(e=t.headers)||void 0===e?void 0:e["set-cookie"])||[];it.COOKIE=j(it.COOKIE,i);const a=null===(n=t.data)||void 0===n?void 0:n.code;switch(a){case qt["账号未登录"]:case qt["账号被封停"]:(async()=>{x.error(`运行结束：${qt[a]}`),await Lt(`异常：${qt[a]}`,N.value),process.exit(0)})();break;default:return t}}),(t=>function(t){const e=t.config;if(0===e.retry)return Promise.reject(t);e.retry||(e.retry=2);if(e.__retryCount=e.__retryCount||0,e.__retryCount>=e.retry)return Promise.reject(t);e.__retryCount+=1;return new Promise((function(t){setTimeout((function(){t(void 0)}),e.retryDelay||100)})).then((function(){return S.default(e)}))}(t)));const Vt=S.default.create({baseURL:Ft}),Zt=S.default.create({baseURL:Qt,headers:{Referer:Yt}}),te=S.default.create({baseURL:Xt,headers:{Referer:Yt}}),ee=S.default.create({baseURL:Wt}),ne=S.default.create({baseURL:zt});async function ie(t=3394945){const e=(new Date).getTime(),{data:n}=await Zt.get(`/xlive/web-room/v1/gift/bag_list?t=${e}&room_id=${t}`);return n}async function ae(t=1,e=10){t>10&&(t=10);const{data:n}=await Zt.get(`/xlive/app-ucenter/v1/user/GetMyMedals?page=${t}&page_size=${e}`);return n}async function se({ruid:t,gift_num:e,bag_id:n,gift_id:i,roomid:a}){const s=it.BILIJCT,o=s,r=d.stringify({gift_id:i,ruid:t,gift_num:e,bag_id:n,biz_id:a,rnd:(new Date).getTime(),send_ruid:0,storm_beat_id:0,metadata:"",price:0,visit_id:"",csrf:s,platform:"pc",biz_code:"Live",csrf_token:o,uid:it.USERID}),{data:c}=await Zt.post("/xlive/revenue/v2/gift/sendBag",r,{headers:{Origin:Jt}});return c}function oe(t,e,n,i,a){const s=Y(),o=s,r=[F(),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(t=>{const e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)}))];return{ua:it.USER_AGENT,id:[n,e,a,t],csrf_token:s,csrf:o,device:r,uname:i}}async function re(){try{await async function(){const{data:t}=await S.default.get("https://api.live.bilibili.com/relation/v1/Feed/heartBeat");return t}()}catch{}}async function ce(t){const{data:{area_id:e,parent_area_id:n,room_id:i}}=await async function(t){const{data:e}=await Zt.get(`/room/v1/Room/get_info?room_id=${t}&from=room`);return e}(t);return{room_id:i,area_id:e,parent_area_id:n}}async function ue(t,e){const n={id:JSON.stringify(t.id),device:JSON.stringify(t.device),ts:(new Date).getTime(),is_patch:0,heart_beat:"[]",ua:t.ua,visit_id:"",csrf:t.csrf,csrf_token:t.csrf_token};try{const{data:i,code:a}=await async function(t){const{data:e}=await S.default.post("https://live-trace.bilibili.com/xlive/data-interface/v1/x25Kn/E",d.stringify(t));return e}(n);if(0===a)return x.info(`进入【${t.uname}】的直播间`),e.v++,i}catch(t){x.verbose(t)}}async function de(t,e,n){if(n.v>6)return;const i={id:JSON.stringify(e.id),device:JSON.stringify(e.device),ets:t.timestamp,benchmark:t.secret_key,time:60,ts:(new Date).getTime(),ua:e.ua},a=function(t,e){const[n,i,a,s]=JSON.parse(t.id),[o,r]=JSON.parse(t.device),{ets:c,time:u,ts:d}=t,f={platform:"web",parent_id:n,area_id:i,seq_id:a,room_id:s,buvid:o,uuid:r,ets:c,time:u,ts:d},l=t.benchmark,g=["MD5","SHA1","SHA256","SHA224","SHA512","SHA384"];let p=JSON.stringify(f);for(const t of e)p=T.createHmac(g[t],l).update(p).digest("hex");return p}(i,t.secret_rule);try{const{data:t,code:s,message:o}=await async function(t){const{data:e}=await S.default.post("https://live-trace.bilibili.com/xlive/data-interface/v1/x25Kn/X",d.stringify(t));return e}(Object.assign({visit_id:"",csrf:e.csrf,csrf_token:e.csrf_token,s:a},i));return 0===s?(x.info(`向【${e.uname}】发送第${n.v}次心跳`),n.v++):x.warn(`向【${e.uname}】发送第${n.v}次心跳失败 ${s} ${o}`),t}catch(t){x.verbose(t)}}async function fe(t=1,e=10){try{const{code:n,message:i,data:a}=await ae(t,e);return 0!==n?(x.verbose(`获取直播间失败 ${n} ${i}`),null):a}catch(t){return x.verbose(`获取直播间异常 ${t.message}`),null}}async function le(t=!0){const e=await async function(){let t=0;try{var e,n;const{data:i,code:a}=await ie();return 0!==a||(null===(e=i.list)||void 0===e?void 0:e.length)<=0?24:(null===(n=i.list)||void 0===n||n.forEach((e=>{if(30607===e.gift_id){const n=(1e3*e.expire_at-(new Date).getTime())/st.MS2DATE;n>6&&n<=7&&(t+=e.gift_num)}})),t>=24?0:24-t)}catch(t){}return 24}();let n;return t?n=await async function(){const{items:t,page_info:e}=await fe();let{total_page:n}=e;if(n&&n>1){n=n>3?3:n;for(let e=2;e<=n;e++){const n=await fe(e,10);t.push(...n.items)}}return t}():({items:n}=await fe()),{fansMedalList:n,heartNum:e}}async function ge(t){var e;let n,i;if(t){const{d:e,hn:a}=JSON.parse(t);n="string"==typeof e?JSON.parse(k(e)):e,i=a}else n=[{seq:{v:0}}],i={v:0};let a=0;if(null!==(e=n[0])&&void 0!==e&&e.seq.v){!function(t){const e=F(),n=Y(),i=it.USER_AGENT;t.forEach((t=>{t.baseData.ua=i,t.baseData.csrf=t.baseData.csrf_token=n,t.baseData.device[0]=e,t.baseData.id[2]=t.seq.v}))}(n);for(const t of n)if(await re(),t.data&&(t.data=await de(t.data,t.baseData,t.seq)),await Ut(1e3),a++,t.seq.v>5&&(t.seq.v=0,a>=i.v))return x.info("今日获取小心心完成"),0;if(n.find((t=>t.seq.v>5)))return 1}else{n.length=0;const{heartNum:t,fansMedalList:e}=await le();i.v=t;for(const t of e){if(0===i.v)return x.info("今日获取小星星已经达到 24"),0;if(a>=i.v)break;const{roomid:e,uname:s}=t,{room_id:o,area_id:r,parent_area_id:c}=await ce(e),u={v:0},d=oe(o,r,c,s,u.v);await re(),await Ut(500);const f=await ue(d,u);n.push({data:f,baseData:d,seq:u}),a++}}return function(t){t.forEach((t=>{delete t.baseData.csrf,delete t.baseData.csrf_token,delete t.baseData.ua,t.baseData.device[0]=0}))}(n),{d:R(JSON.stringify(n)),hn:i,l:n.length}}const pe={silver2Coin:!0,liveSignTask:!0,addCoins:!0,mangaSign:!1,shareAndWatch:!0,supGroupSign:!1,liveSendMessage:!1,taskReward:!0,charging:!1,getVipPrivilege:!1,giveGift:!1,matchGame:!1};function he(t){return function(){for(const t in pe)if(Object.prototype.hasOwnProperty.call(pe,t)){const e=pe[t];switch((it.config.function||{})[t]){case!0:!1===e&&(pe[t]=!0);break;case!1:!0===e&&(pe[t]=!1)}}pe.addCoins||pe.shareAndWatch||(pe.taskReward=!1)}(),t.map((t=>pe[t.name]?t:null)).filter((t=>t))}async function me(){const{data:t}=await te.get("/x/web-interface/nav",{retry:3,headers:{Origin:jt}});return t}async function _e(){const{data:t}=await te.get("/x/web-interface/coin/today/exp");return t}function ye(t){const e=t.level_info,n=e.current_level;if(n>=it.BILI_TARGET_LEVEL&&(at.coinsTask=0),x.info(`当前等级: ${e.current_level}`),n>=6)pe.shareAndWatch=!1,pe.addCoins=!1,x.info("已经满级，不需要再投币了，做个白嫖怪吧");else{const t=e.next_exp-e.current_exp;x.info(`距离升级还需要 ${t} 经验，预计 ${function(t){if(it.BILI_TARGET_COINS<=0)return t/15;const e=10*it.BILI_TARGET_COINS+15,n=t/e,i=at.money/(it.BILI_TARGET_COINS-1);return n<i?Math.floor(n):(t-i*e)/25+i}(t).toFixed(2)} 天`)}}async function we(t){try{var e;const{data:n}=await async function(){const{data:t}=await Vt.get("/site/getCoin");return t}();x.info(`登录成功: ${t.uname}`),x.info(`硬币余额: ${n.money||0}`),it.NICKNAME=function(t){const e=t.length;return e<=3?t:`${t[0]}**${t[e-1]}`}(t.uname),at.money=n.money||0,at.bCoinCouponBalance=(null===(e=t.wallet)||void 0===e?void 0:e.coupon_balance)||0,ye(t),function(t){let e="";switch(at.vipType=t.vipType,t.vipType){case 0:e="无大会员";break;case 1:e="月度大会员";break;case 2:e="年度大会员"}0===t.vipStatus&&(e="无大会员"===e?e:e+"[已过期]"),x.info(`大会员状态: ${e}`)}(t)}catch(t){x.error(`获取硬币信息异常: ${t.message}`)}}async function ve(t,e=12,n=1){try{const{data:i}=await te.get("/x/space/article",{params:{callback:"__test",jsonp:"jsonp",sort:"publish_time",pn:n,ps:e,mid:t}});return function(t){const e=t.replace(/^\w+\(/,"").replace(/\)$/,"");return JSON.parse(e)}(i)}catch(t){console.log(t)}}async function $e(t,e,n=1){const{data:i}=await te.post("/x/web-interface/coin/add",d.stringify({aid:t,multiply:e,selectLike:n,csrf:it.BILIJCT}));return i}async function Te(t,e=1){const{data:n}=await S.default.post("https://www.bilibili.com/audio/music-service-c/web/coin/add",d.stringify({sid:t,multiply:e,csrf:it.BILIJCT}));return n}const Se="video",be="audio",Ee="article";async function Ie(t=!0){try{const e=it.USERID;let n;n=t?await async function(t=1,e=50){const{data:n}=await te.get("/x/relation/tag",{params:{tagid:-10,pn:t,ps:e}});return n}():await async function(t,e=1,n=50,i="desc",a="attention"){const{data:s}=await te.get("/x/relation/followings",{params:{vmid:t,pn:e,ps:n,order:i,order_type:a}});return s}(e);const{data:i,message:a,code:s}=n;if(0===s&&i.length>0){await Ut();const{mid:t}=i[C(i.length-1)];return await Ne(t)}return 0===i.length?{msg:"-1",data:{}}:{msg:t?`未获取到特别关注列表: ${s}-${a}`:`未获取到关注列表: ${s}-${a}`,data:{}}}catch(t){return{msg:t.message,data:{}}}}async function Oe(){const t=[1,3,4,5,160,22,119],e=t[C(t.length-1)];try{const{data:t,message:n,code:i}=await async function(t=1,e=3){const{data:n}=await te.get("/x/web-interface/ranking/region",{params:{rid:t,day:e}});return n}(e,3);if(0==i){const{aid:e,title:n,author:i}=t[C(t.length-1)];return{msg:"0",data:{id:Number(e),title:n,author:i}}}return{msg:`未获取到排行信息: ${i}-${n}`,data:{}}}catch(t){return{msg:t.message,data:{}}}}async function Ce(){const t=it.BILI_CUSTOMIZE_UP;if(0===t.length)return{msg:"-1",data:{}};const e=t[C(t.length-1)];return await Ne(e)}async function Ne(t){try{const{code:e,data:n,message:i}=await async function(t){const{data:e}=await te.get(`/x/space/navnum?mid=${t}`);return e}(t);if(e)return{msg:`通过uid获取视频失败: ${e}-${i}`,data:{}};await Ut();const{video:a,audio:s,article:o}=n,{type:r,page:c,index:u}=function([t,e,n]){const i=t+e+n;if(!i)return;const a=C(0,i-1);let s=a;if(a<t)return{type:Se,page:I(30,s+1),index:s%30};const o=t+e;return s=a-t,a<o?{type:be,page:I(30,s+1),index:s%30}:(s=a-o,{type:Ee,page:I(12,s+1),index:s%12})}([a,s,o]),d={[Se]:xe,[be]:Ae,[Ee]:Re},f=await d[r](t,c,u);return f.message?{msg:f.message,data:{}}:{msg:"0",data:f}}catch(t){return x.debug(t),{msg:t.message,data:{}}}}async function xe(t,e,n){const{code:i,data:a,message:s}=await async function(t,e=30,n=1,i=""){const{data:a}=await te.get("/x/space/arc/search",{params:{jsonp:"jsonp",order:"pubdate",keyword:i,pn:n,tid:0,ps:e,mid:t}});return a}(t,30,e);if(i)return{message:s};const{aid:o,title:r,author:c}=a.list.vlist[n];return{type:Se,id:o,title:r,author:c}}async function Ae(t,e,n){const{code:i,data:a,msg:s}=await async function(t,e=30,n=1){const{data:i}=await te.get("/audio/music-service/web/song/upper",{params:{jsonp:"jsonp",order:1,pn:n,ps:e,uid:t}});return i}(t,30,e);if(i)return{message:s};const{data:o}=a,{id:r,uname:c,title:u}=o[n];return{type:be,id:r,title:u,author:c}}async function Re(t,e,n){const{code:i,data:a,message:s}=await ve(t,12,e);if(i)return{message:s};const{articles:o}=a,{id:r,title:c,author:{name:u}}=o[n];return{type:Ee,id:r,title:c,author:u,mid:t}}async function ke(){let t;const e=[Ce,Ie,()=>Ie(!1),Oe];it.BILI_CUSTOMIZE_UP||e.shift(),e.splice(0,at.currentStartFun);for(let i=0;i<e.length;i++){var n;const a=e[i];if(t=await a(),"0"===t.msg)return t;let s=Number(null!==(n=it.BILI_COIN_RETRY_NUM)&&void 0!==n?n:4);for(s=s<1?1:s>8?8:s;s--;)if(await Ut(),t=await a(),"-1"===t.msg&&(s=0),"0"===t.msg)return t;s<=0&&(at.currentStartFun=i)}return{msg:"-1",data:{id:0}}}async function Pe({id:t,coin:e=1,type:n="video",mid:i}){const a={[Se]:$e,[be]:Te,[Ee]:(t,e=1)=>async function(t,e,n=1){const{data:i}=await te.post("/x/web-interface/coin/add",d.stringify({aid:e,upid:t,avtype:2,multiply:n,csrf:it.BILIJCT}));return i}(i,t,e)},s=await a[n](Number(t),e);return{code:s.code,message:s.message||s.msg}}async function De(t,e){const{data:n}=await ne.get("/link_setting/v1/link_setting/sign_in",{params:{group_id:t,owner_id:e}});return n}async function Le(){try{const{data:t,code:e,message:n}=await async function(){const{data:t}=await ne.get("/link_group/v1/member/my_groups");return t}();return 0===e?(null==t?void 0:t.list)||[]:(x.warn(`获取自己的应援团异常失败: ${n}`),[])}catch(t){x.error(`获取自己的应援团异常: ${t}`)}}const Ue=["棒","棒唉","棒耶","加油~","UP加油!","支持~","支持支持！","催更啦","顶顶","留下脚印~","干杯","bilibili干杯","o(*￣▽￣*)o","(｡･∀･)ﾉﾞ嗨","(●ˇ∀ˇ●)","( •̀ ω •́ )y","(ง •_•)ง",">.<","^_~"],Be=["(⌒▽⌒)","（￣▽￣）","(=・ω・=)","(｀・ω・´)","(〜￣△￣)〜","(･∀･)","(°∀°)ﾉ","(￣3￣)","╮(￣▽￣)╭","_(:3」∠)_","( ´_ゝ｀)","←_←","→_→","(<_<)","(>_>)","(;¬_¬)","(ﾟДﾟ≡ﾟдﾟ)!?","Σ(ﾟдﾟ;)","Σ( ￣□￣||)","(´；ω；`)","（/TДT)/","(^・ω・^ )","(｡･ω･｡)","(●￣(ｴ)￣●)","ε=ε=(ノ≧∇≦)ノ","(´･_･`)","(-_-#)","（￣へ￣）","(￣ε(#￣) Σ","ヽ(`Д´)ﾉ","（#-_-)┯━┯","(╯°口°)╯(┴—┴","←◡←","( ♥д♥)","Σ>―(〃°ω°〃)♡→","⁄(⁄ ⁄•⁄ω⁄•⁄ ⁄)⁄","(╬ﾟдﾟ)▄︻┻┳═一","･*･:≡(　ε:)","(汗)","(苦笑)"].concat("1","2","3","4","5","6","7","8","9","签到","哈哈");async function Ge(){try{const{code:t,message:e,data:n}=await async function(t=1,e=256,n=1){const{data:i}=await Zt.get(`/xlive/app-ucenter/v1/fansMedal/panel?page=${t}&page_size=${e}&target_id=${n}`);return i}(1,256,it.USERID);return 0!==t?(x.verbose(`获取勋章信息失败 ${t} ${e}`),null):n}catch(t){return x.error(`获取勋章异常 ${t.message}`),null}}async function Me(t,e){const n=Be[C(Be.length-1)];try{const{code:i,message:a}=await async function(t,e){const n=it.BILIJCT,i=n;e||(e=C(10).toString());const{data:a}=await Zt.post("/msg/send",d.stringify({color:5566168,fontsize:25,mode:1,msg:e,rnd:Date.now(),roomid:t,bubble:0,csrf:n,csrf_token:i}));return a}(t,n);return 0===i||(11e3===i?(x.warn(`【${e}】${t}-可能未开启评论`),!1):(x.warn(`【${e}】${t}-发送失败 ${a}`),x.verbose(`code: ${i}`),!1))}catch(t){x.verbose(`发送弹幕异常 ${t.message}`)}}async function He(){try{const{data:t,message:e,code:n}=await me();if(0!==n)return void x.warn(`获取用户信息失败：${n} ${e}`);!function(t){var e;at.bCoinCouponBalance=(null===(e=t.wallet)||void 0===e?void 0:e.coupon_balance)||0}(t)}catch(t){x.error(`获取用户信息异常：${t.message}`)}}var Ke;async function qe(t){try{const e=function(t){switch(t){case 1:return"B 币券";case 2:return"大会员优惠券";default:return""}}(t),{code:n,message:i}=await async function(t=1){const{data:e}=await te.post("/x/vip/privilege/receive",d.stringify({csrf:it.BILIJCT,type:t}));return e}(t);let a="成功";return 0===n&&(a=`失败 ${i}`),x.info(`领取${e} ${a}`),!0}catch(t){x.error(`领取权益出现异常：${t.message}`)}return!1}async function je(t){let e=0,n=!1;for(;!(n||(n=await qe(t),e>2));)e++;return n}!function(t){t[t["成功"]=4]="成功",t[t["低于20电池"]=-2]="低于20电池",t[t["B币不足"]=-4]="B币不足"}(Ke||(Ke={}));const{BILI_GIFT_UP:Je}=it;let Ye=0;async function Fe(){try{const{data:{list:t}}=await ie();return t.filter((t=>!![1,30607].includes(t.gift_id)&&(1e3*t.expire_at-(new Date).getTime())/st.MS2DATE<2))}catch(t){if(Ye)return null;await Fe(),Ye++}}async function Qe(t){try{const{data:{live_room:e}}=await async function(t){const{data:e}=await te.get(`/x/space/acc/info?mid=${t}&jsonp=jsonp`);return e}(t);if(await Ut(),e.roomStatus)return{roomid:e.roomid}}catch{}return{roomid:0}}const Xe=it.BILIJCT,We=Xe;async function ze(t,e,n,i){const a=d.stringify({is_fav:0,main_id:e,oid:t,detail_id:n,count:i,csrf:Xe,csrf_token:We}),{data:s}=await te.post("/x/esports/guess/add",a);return s}const{MATCH_SELECTION:Ve,MATCH_COINS:Ze}=it;function tn(){return at.money-Ze<it.BILI_TARGET_COINS&&(x.info(`需要保留${it.BILI_TARGET_COINS}个硬币，任务结束`),!0)}var en={taskReward:async function(){x.info("----【每日任务完成情况】----");try{const{data:t,message:e,code:n}=await async function(){const{data:t}=await te.get("/x/member/web/exp/reward");return t}();await Ut();const{data:i}=await _e();if(0!=n)return void x.warn(`状态获取失败: ${n} ${e}`);const a=at.money-it.BILI_STAY_COINS;let s=0;0===at.coinsTask?x.info(`今日投币获取经验: ${i}，还需投币0颗，经验够了，不想投了`):a<=0?x.info(`今日投币获取经验: ${i}，还需投币0颗，硬币不够了，不投币了`):a<at.coinsTask?(s=at.coinsTask-a,x.info(`投币获取经验: ${i}，还需投币数量: ${s}颗;(目标${at.coinsTask}颗，忽略部分投币)`)):(s=at.coinsTask-i/10,x.info(`投币获取经验: ${i}，还需投币数量: ${s}颗;(目标${at.coinsTask}颗)`)),at.coinsTask=s,x.info("每日分享: "+(t.share?"已完成":"[未完成]")),x.info("每日播放: "+(t.watch?"已完成":"[未完成]")),at.share=t.share,at.watch=t.watch}catch(t){x.error(`状态获取异常 ${t.message}`)}},liveSignTask:async function(){x.info("----【直播签到】----");try{const{data:t}=await async function(){const{data:t}=await Zt.get("/xlive/web-ucenter/v1/sign/WebGetSignInfo");return t}();if(1===t.status)return x.info("已签到，跳过签到"),void x.info(`已经签到${t.hadSignDays}天，${t.specialText}`)}catch(t){}try{const{code:t,data:e,message:n}=await async function(){const{data:t}=await Zt.get("/xlive/web-ucenter/v1/sign/DoSign");return t}();0===t?x.info(`直播签到成功: ${e.text}，特别信息: ${e.specialText}，本月签到天数: ${e.hadSignDays}天;`):x.warn(`直播签到失败: ${t} ${n}`)}catch(t){x.error(`直播签到异常: ${t.message}`)}},shareAndWatch:async function(){if(x.info("----【分享/播放视频】----"),at.share&&at.watch)return void x.info("已完成，跳过分享/播放");let t=0;try{let e=await Ce();if("-1"===e.msg&&(e=await Oe()),"0"!==e.msg)return x.warn(`获取视频失败 ${e.msg}`),!1;{const{id:n,author:i,title:a}=e.data;t=n,x.info(`获取视频: ${a} --up【${i}】`)}}catch(t){return x.error(`获取视频出现异常: ${t.message}`),!1}if(!at.share){await Ut();try{const{code:e,message:n}=await async function(t){const e={csrf:it.BILIJCT,aid:t},{data:n}=await te.post("/x/web-interface/share/add",d.stringify(e));return n}(t);0===e?x.info("分享视频成功!"):x.warn(`分享视频失败: ${e} ${n}`)}catch(t){x.error(`分享视频异常: ${t.message}`)}}if(!at.watch){await Ut();try{const{code:e,message:n}=await async function(t,e){const{data:n}=await te.post("/x/click-interface/web/heartbeat",d.stringify({aid:t,played_time:e}));return n}(t,C(4,60));0===e?x.info("播放视频成功!"):x.warn(`播放视频失败: ${e} ${n}`)}catch(t){x.error(`播放视频异常: ${t.message}`)}}},silver2Coin:async function(){x.info("----【银瓜子兑换硬币】----");try{const{data:t,code:e,message:n}=await async function(){const{data:t}=await Zt.get("/xlive/revenue/v1/wallet/getStatus");return t}();if(0!=e&&x.info(`获取瓜子详情失败 ${n}`),0===t.silver_2_coin_left)x.info("今日已兑换一次");else if(t.silver<700)x.info("兑换失败，你瓜子不够了");else{const{message:t}=await async function(){const{data:t}=await Zt.post("/xlive/revenue/v1/wallet/silver2coin",d.stringify({csrf_token:it.BILIJCT,csrf:it.BILIJCT}));return t}();x.info(t),await async function(){const{data:t}=await Zt.get("/xlive/revenue/v1/wallet/myWallet?need_bp=1&need_metal=1&platform=pc");return t}()}}catch(t){x.error(`操作异常 ${t.message}`)}},addCoins:async function(){if(x.info("----【视频投币】----"),!at.coinsTask)return void x.info("跳过投币，今日已完成");let t,e=0,n=0;for(;at.coinsTask&&n<5;){try{const{data:t,code:e}=await _e();if(0==e){const e=it.BILI_TARGET_COINS-t/10;at.coinsTask=e>0?e:0}}catch(t){}if(at.coinsTask<=0||at.money<=0)break;const{data:i,msg:a}=await ke();if(null==i||!i.id||"0"!=a){n++;continue}await Ut();const{id:s,title:o,author:r,type:c,mid:u}=i;try{const i=await Pe({id:s,type:c,mid:u});if(0===i.code)at.money--,at.coinsTask--,e++,x.info(`给[${o}--up【${r}】]投币成功`);else{if(n++,-111===i.code||-104===i.code){x.warn(`${s} ${i.message} 无法继续进行投币`);break}if(x.warn(`给up投币失败 ${i.code} ${i.message}`),t===i.code)break;t=i.code}}catch(t){n++,x.error(`投币异常 ${t.message}`)}finally{await Ut(1500)}}n>=5&&x.info("出现异常/错误5次，自动退出投币"),x.info(`一共成功投币${e}颗`),x.info(`硬币还剩${at.money}颗`)},mangaSign:async function(){x.info("----【漫画签到】----");try{const{code:t}=await async function(t="android"){const{data:e}=await ee.post("/twirp/activity.v1.Activity/ClockIn",d.stringify({platform:t}));return e}();0==t?x.info("漫画签到成功"):x.warn("漫画签到失败")}catch(t){400===t.response.status?x.info("已经签到过了，跳过任务"):x.error(`漫画签到异常 ${t.message}`)}},supGroupSign:async function(){x.info("----【应援团签到】----");const t=await Le();await Ut();let e=0;for(let n=0;n<t.length;){const i=t[n];try{const{data:t,code:n,message:a}=await De(i.group_id,i.owner_uid);0===n?0===t.status?e++:x.info(a):x.warn(`[${i.group_name}]签到失败 ${a}`)}catch(t){x.error(`签到异常 ${t.message}`)}finally{await Ut()}}x.info(`签到结束，成功${e}/${t.length}`)},liveSendMessage:async function(){x.info("----【发送直播弹幕】----");const t=await async function(){const{list:t,special_list:e}=await Ge();return t.push(...e),t}(),e=t.length;let n=0,i=0;x.info(`一共需要发送${e}个直播间`),x.verbose("所需时间可能很长，请耐心等待");for(let a=0;a<e;a++){const{room_info:s,anchor_info:o,medal:r}=t[a];null!=s&&s.room_id?100!==r.today_feed?(await Me(s.room_id,o.nick_name)&&n++,a<e-1&&await Ut(C(1e4,25e3))):i++:(x.info(`【${o.nick_name}】没有直播间哦`),i++)}x.info(`成功发送${n}个弹幕，跳过${i}个`)},charging:async function(){if(x.info("----【给目标充电】----"),await He(),await Ut(),function(){const t=E(),e=t.getDate(),n=b(t),i=it.CHARGE_PRESET_TIME;return at.bCoinCouponBalance<2?(x.info(`剩余券为${at.bCoinCouponBalance}，不足2跳过充电`),!1):n===e?(x.info("今天是最后一天了"),!0):!(i>e&&(x.info(`预设时间为${i}，不符合条件`),1))}())try{const t=at.bCoinCouponBalance||0,e=it.CHARGE_ID;let n=0;x.info(`b 币券余额${t}`);const i=async()=>{const{code:n,message:i,data:a}=await async function(t=50,e=!0,n=it.USERID,i="up",a=n){const{data:s}=await te.post("/x/ugcpay/web/v2/trade/elec/pay/quick",d.stringify({csrf:it.BILIJCT,bp_num:t,is_bp_remains_prior:e,up_mid:n,otype:i,oid:a}));return s}(t,!0,e);0===n?(x.info(`【充值结果】${Ke[a.status]}`),a.status===Ke["成功"]&&(at.chargeOrderNo=a.order_no,await Ut(),await async function(){try{if(!at.chargeOrderNo)return!1;const t=Ue[C(0,Ue.length-1)],{code:e}=await async function(t,e="支持大佬一波"){const{data:n}=await te.post("/x/ugcpay/trade/elec/message",d.stringify({csrf:it.BILIJCT,message:e,order_id:t}));return n}(at.chargeOrderNo,t);0===e&&x.info("留言成功！")}catch{}}())):x.warn(`充电失败：${n} ${i}`)};for(at.chargeOrderNo="";!(at.chargeOrderNo||(await i(),await Ut(),n++>2)););}catch(t){x.error(`充电出现异常：${t.message}`)}},getVipPrivilege:async function(){x.info("----【领取大会员权益】----"),function(){if(2!==at.vipType)return x.info("账号非年度大会员，不需要领取权益"),!1;const t=E(),e=t.getDate(),n=b(t);return 1===e||n===e||(x.info("今天非预订领取时间，跳过领取"),!1)}()&&(await je(1),await je(2))},giveGift:async function(){x.info("----【投喂过期食物】----");try{const t=await Fe();if(await Ut(),null==t||!t.length)return void x.info("没有2天内过期的简单礼物");const{roomid:e,mid:n}=await async function(){const t=Object.assign([],Je),e=()=>t.splice(C(Je.length-1),1)[0];for(;t.length;){const t=e(),{roomid:n}=await Qe(t);if(n)return{roomid:n,mid:t}}return await async function(){const{data:{count:t,items:e}}=await ae();if(await Ut(),!t)return{roomid:0,mid:0};const n=e[C(e.length-1)];return{mid:n.target_id,roomid:(null==n?void 0:n.roomid)||0}}()}();if(!e)return void x.info("没有找到投喂目标");await async function({roomid:t,mid:e},n){for(const i of n){await Ut();try{const{code:n,message:a,data:s}=await se({roomid:t,ruid:e,bag_id:i.bag_id,gift_id:i.gift_id,gift_num:i.gift_num});0!==n?x.warn(`给[ ${s.uname} ]投喂${s.gift_name}: ${a}`):x.info(`成功给[ ${s.uname} ]投喂${s.gift_num}${s.gift_name}`)}catch{}}}({roomid:e,mid:n},t)}catch(t){x.info(`投喂过期食物异常 ${t}`)}},matchGame:async function(){if(x.info("----【赛事硬币竞猜】----"),Ze<=0)return void x.info("硬币数量不能小于 0");if(tn())return;const t=await async function(){try{const{code:t,message:e,data:{list:n,page:i}}=await async function(t="",e=""){const{data:n}=await te.get(`/x/esports/guess/collection/question?pn=1&ps=50&gid=&sids=&stime=${t}&etime=${e}`);return n}();return 0!==t?void x.warn(`获取赛事错误 ${t} ${e}`):0===i.total?(x.info("今日已经无法获取赛事"),null):n}catch(t){}}();if(await Ut(),!t)return;const e=await async function(t){let e=0;try{for(const n of t){const{contest:t,questions:i}=n,a=t.id,[{id:s,title:o,details:r,is_guess:c}]=i,[u,d]=r;if(tn())return e;if(c)continue;x.info(`${o} <=> ${u.odds}:${d.odds}`);const f=u.odds>d.odds;let l;l=Ve>0?f?d:u:f?u:d,x.info(`预测[ ${l.option} ] ${Ze} 颗硬币`),await Ut();const{code:g}=await ze(a,s,l.detail_id,Ze);0!==g?x.info("预测失败"):(e++,at.money-=Ze)}}catch(t){console.warn(t.message)}return e}(function(t,e){return t.filter((t=>{const{questions:n}=t,[{details:i,is_guess:a}]=n;if(a)return!1;const[s,o]=i;return Math.abs(s.odds-o.odds)>=e}))}(t,it.MATCH_DIFF));x.info(`【竞猜结束】一共参与${e}次预测`)}};async function nn(t,...e){try{await async function(){x.info("----【登录】----");try{const{data:t,message:e,code:n}=await me();if(65006===n||-404===n)return void x.error(`登录错误 ${n} ${e}`);if(0!==n)return void x.error(`登录错误 ${n} ${e}`);if(!t.isLogin)throw new Error("接口返回为未登录");await Ut(),await we(t)}catch(t){throw new Error(t.message)}}()}catch(t){return x.error(`登录失败: ${t}`),await Lt("登录失败",N.value),"未完成"}const n=he([...Object.values(en)]);for(const t of n)await t(),await Ut();return t&&await t(...e),await Lt("每日完成",N.value),"完成"}exports.main_handler=function(t){return t.TriggerName===st.HEART_TRIGGER_NAME?async function(t){let e;Dt();try{e=JSON.parse(t.Message)}catch(t){}if(e&&!e.d&&e.lastTime===E().getDate().toString())return"今日重复执行";const n=await ge(t.Message);return 0===n?(await Ht(st.HEART_TRIGGER_NAME),"今日完成"):1===n?(await Ht(st.HEART_TRIGGER_NAME,{hn:{v:0},d:[{seq:{v:0}}]},O(5e3)),"等待继续下一轮"):(await Ht(st.HEART_TRIGGER_NAME,n,O(62e3-1e3*n.l)),"等待继续下次心跳")}(t):async function(t){let e;Dt();try{e=JSON.parse(t.Message)}catch(t){}return e&&e.lastTime===E().getDate().toString()?"今日重复执行":await nn(Ht)}(t)};
